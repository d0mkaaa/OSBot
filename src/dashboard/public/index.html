<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot Dashboard</title>
  <link rel="stylesheet" href="/dashboard.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="/utils.js"></script>
  <script src="/api-client.js"></script>
  <script src="/embed-builder.js"></script>
  <script src="/console.js"></script>
  <script src="/chat-viewer.js"></script>
  <script src="/permission-manager.js"></script>
  <script src="/moderation-queue.js"></script>
  <script src="/analytics-charts.js"></script>
  <script src="/bulk-actions.js"></script>
  <script src="/backup-manager.js"></script>
  <script src="/custom-filters.js"></script>
  <script src="/xp-boosters.js"></script>
  <script src="/music-player.js"></script>
  <script src="/security-manager.js"></script>
  <style>
    .scrollbar-thin::-webkit-scrollbar {
      width: 8px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #27272a;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #52525b;
      border-radius: 4px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #71717a;
    }
    .prose-invert {
      color: #d4d4d8;
    }
    .prose-invert h1 {
      color: #fafafa;
      font-size: 2.25rem;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #3f3f46;
      padding-bottom: 0.5rem;
    }
    .prose-invert h2 {
      color: #fafafa;
      font-size: 1.875rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #3f3f46;
      padding-bottom: 0.5rem;
    }
    .prose-invert h3 {
      color: #e4e4e7;
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }
    .prose-invert h4 {
      color: #e4e4e7;
      font-size: 1.25rem;
      font-weight: 600;
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
    }
    .prose-invert p {
      margin: 1rem 0;
      line-height: 1.75;
    }
    .prose-invert ul, .prose-invert ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }
    .prose-invert li {
      margin: 0.5rem 0;
    }
    .prose-invert code {
      background: #27272a;
      color: #a5f3fc;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.875em;
      font-family: 'Courier New', monospace;
    }
    .prose-invert pre {
      background: #18181b;
      border: 1px solid #3f3f46;
      border-radius: 0.5rem;
      padding: 1rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    .prose-invert pre code {
      background: transparent;
      padding: 0;
      color: #e4e4e7;
    }
    .prose-invert a {
      color: #60a5fa;
      text-decoration: none;
    }
    .prose-invert a:hover {
      text-decoration: underline;
    }
    .prose-invert blockquote {
      border-left: 4px solid #3f3f46;
      padding-left: 1rem;
      margin: 1rem 0;
      color: #a1a1aa;
      font-style: italic;
    }
    .prose-invert table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    .prose-invert th, .prose-invert td {
      border: 1px solid #3f3f46;
      padding: 0.5rem;
      text-align: left;
    }
    .prose-invert th {
      background: #27272a;
      font-weight: 600;
    }
    .prose-invert strong {
      color: #fafafa;
      font-weight: 600;
    }
    .prose-invert hr {
      border: 0;
      border-top: 1px solid #3f3f46;
      margin: 2rem 0;
    }
  </style>
</head>
<body class="bg-zinc-900 text-white">
  <div id="app"></div>

  <script>

    const userCache = {};

    async function getUserDisplay(userId) {
      if (userCache[userId]) {
        return userCache[userId];
      }

      try {
        const result = await API.fetchUserInfo(currentGuild, userId);
        if (result.success) {
          const user = result.data;
          const displayName = user.nickname || user.username;
          const fullTag = user.discriminator !== '0' ? `${user.username}#${user.discriminator}` : user.username;
          userCache[userId] = {
            displayName,
            fullTag,
            avatar: user.avatar,
            id: user.id,
            joinedAt: user.joinedAt
          };
          return userCache[userId];
        }
      } catch (error) {
        console.error('Failed to fetch user:', error);
      }

      return {
        displayName: `User ${userId}`,
        fullTag: `User ${userId}`,
        avatar: null,
        id: userId,
        joinedAt: null
      };
    }

    function renderUserTag(userId, showAvatar = false) {
      const cachedUser = userCache[userId];
      if (!cachedUser) {
        return `<span class="user-tag loading" data-user-id="${userId}">Loading...</span>`;
      }

      const avatarHtml = showAvatar && cachedUser.avatar
        ? `<img src="${cachedUser.avatar}" class="inline-block w-6 h-6 rounded-full mr-2" alt="${cachedUser.displayName}">`
        : '';

      const joinedText = cachedUser.joinedAt
        ? `Joined: ${new Date(cachedUser.joinedAt).toLocaleDateString()}`
        : 'Join date unknown';

      const tooltipId = `tooltip-${userId}-${Math.random().toString(36).substr(2, 9)}`;

      return `
        <span class="user-tag-wrapper inline-flex items-center" data-user-id="${userId}">
          <span class="user-tag-trigger inline-flex items-center cursor-help text-indigo-400 hover:text-indigo-300" onmouseenter="showTooltip('${tooltipId}', event)" onmouseleave="scheduleHideTooltip('${tooltipId}')">
            ${avatarHtml}
            <span>${cachedUser.displayName}</span>
          </span>
          <div id="${tooltipId}" class="user-tooltip hidden fixed bg-zinc-900 border border-zinc-700 rounded-lg p-3 z-50 min-w-[200px] shadow-xl pointer-events-none" onmouseenter="cancelHideTooltip('${tooltipId}')" onmouseleave="hideTooltip('${tooltipId}')">
            <div class="flex items-center gap-2 mb-2 pointer-events-auto">
              ${cachedUser.avatar ? `<img src="${cachedUser.avatar}" class="w-10 h-10 rounded-full" alt="${cachedUser.displayName}">` : ''}
              <div>
                <div class="font-bold text-sm">${cachedUser.displayName}</div>
                <div class="text-xs text-zinc-400">${cachedUser.fullTag}</div>
              </div>
            </div>
            <div class="text-xs text-zinc-500 border-t border-zinc-700 pt-2 pointer-events-auto">
              <div>ID: ${cachedUser.id}</div>
              <div>${joinedText}</div>
            </div>
          </div>
        </span>
      `;
    }

    let tooltipTimeout = null;

    function showTooltip(tooltipId, event) {
      cancelHideTooltip(tooltipId);
      const tooltip = document.getElementById(tooltipId);
      if (tooltip && event) {
        const rect = event.target.closest('.user-tag-trigger').getBoundingClientRect();
        tooltip.style.left = rect.left + 'px';
        tooltip.style.top = (rect.bottom + 4) + 'px';
        tooltip.classList.remove('hidden');
        tooltip.style.pointerEvents = 'auto';
      }
    }

    function scheduleHideTooltip(tooltipId) {
      tooltipTimeout = setTimeout(() => hideTooltip(tooltipId), 100);
    }

    function cancelHideTooltip(tooltipId) {
      if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
      }
    }

    function hideTooltip(tooltipId) {
      const tooltip = document.getElementById(tooltipId);
      if (tooltip) {
        tooltip.classList.add('hidden');
        tooltip.style.pointerEvents = 'none';
      }
    }

    async function preloadUsers(userIds) {
      const uniqueIds = [...new Set(userIds)];
      const missingIds = uniqueIds.filter(id => !userCache[id]);

      await Promise.all(missingIds.map(id => getUserDisplay(id)));
    }

    function formatActionType(actionType) {
      if (!actionType) return 'Unknown';

      return actionType
        .split('_')
        .map(word => word.charAt(0) + word.slice(1).toLowerCase())
        .join(' ');
    }

    function renderLogin() {
      return `
        <div class="min-h-screen flex items-center justify-center">
          <div class="bg-zinc-800 p-8 rounded-lg shadow-xl max-w-md w-full">
            <h1 class="text-3xl font-bold mb-6 text-center">Bot Dashboard</h1>
            <p class="text-zinc-400 mb-6 text-center">Manage your Discord bot from the web</p>
            <a href="/auth/login" class="block w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded text-center transition">
              Login with Discord
            </a>
          </div>
        </div>
      `;
    }

    function renderDashboard(user, isOwner, botClientId) {
      const guilds = user.guilds || [];
      const adminGuilds = guilds.filter(g => (g.permissions & 0x8) === 0x8);
      const botGuilds = adminGuilds.filter(g => g.botInGuild);
      const nonBotGuilds = adminGuilds.filter(g => !g.botInGuild);

      return `
        <div class="min-h-screen">
          <nav class="bg-zinc-800 border-b border-zinc-700 px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-xl">ü§ñ</div>
                <h1 class="text-2xl font-bold text-white">OSBot Dashboard</h1>
              </div>
              <div class="flex items-center gap-4">
                <button onclick="showAccountSettings()" class="text-zinc-400 hover:text-white transition flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span class="hidden md:inline">Settings</span>
                </button>
                <div class="flex items-center gap-3 bg-zinc-700/50 rounded-lg px-4 py-2">
                  <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center font-bold text-sm">
                    ${user.username.charAt(0).toUpperCase()}
                  </div>
                  <span class="text-white font-medium hidden md:inline">${user.username}${user.discriminator !== '0' ? '#' + user.discriminator : ''}</span>
                  ${isOwner === false ? '<span class="text-yellow-400 text-xs px-2 py-1 bg-yellow-900/20 rounded">Limited</span>' : ''}
                </div>
                <a href="/auth/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm transition">Logout</a>
              </div>
            </div>
          </nav>

          <div class="container mx-auto px-6 py-8">
            ${isOwner === false ? `
              <div class="bg-yellow-900/20 border border-yellow-600/30 p-4 rounded-lg mb-6 flex items-start gap-3">
                <svg class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                  <p class="text-yellow-400 font-semibold">Limited Access</p>
                  <p class="text-yellow-200/80 text-sm mt-1">Dashboard access is restricted to bot owners. Contact the bot administrator for full access.</p>
                </div>
              </div>
            ` : ''}

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
              <button onclick="showDashboardSecurity()" class="group bg-zinc-800 hover:bg-zinc-750 border border-zinc-700 p-6 rounded-lg transition text-left">
                <div class="flex items-start justify-between mb-4">
                  <div class="w-12 h-12 bg-indigo-600/20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                  </div>
                  <span class="text-indigo-400 text-xs font-semibold px-2 py-1 bg-indigo-600/20 rounded">Security</span>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Security Logs</h3>
                <p class="text-zinc-400 text-sm">Track dashboard access and audit all security events</p>
              </button>

              <button onclick="showConsole()" class="group bg-zinc-800 hover:bg-zinc-750 border border-zinc-700 p-6 rounded-lg transition text-left">
                <div class="flex items-start justify-between mb-4">
                  <div class="w-12 h-12 bg-green-600/20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <span class="text-green-400 text-xs font-semibold px-2 py-1 bg-green-600/20 rounded">Live</span>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Console Logs</h3>
                <p class="text-zinc-400 text-sm">Monitor real-time bot activity and system events</p>
              </button>

              <div class="bg-zinc-800 border border-zinc-700 p-6 rounded-lg">
                <div class="flex items-start justify-between mb-4">
                  <div class="w-12 h-12 bg-purple-600/20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">${botGuilds.length} Active Servers</h3>
                <p class="text-zinc-400 text-sm">Managing ${botGuilds.length} server${botGuilds.length !== 1 ? 's' : ''} with administrator access</p>
              </div>
            </div>

            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-white">Your Servers</h2>
                <p class="text-zinc-400 text-sm mt-1">Select a server to manage its settings and configuration</p>
              </div>
            </div>

            ${adminGuilds.length === 0 ? `
              <div class="bg-zinc-800/50 border border-zinc-700 p-12 rounded-xl text-center">
                <svg class="w-20 h-20 mx-auto mb-4 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <p class="text-zinc-400 text-lg font-medium">No servers found</p>
                <p class="text-zinc-500 text-sm mt-2">You don't have administrator permissions in any servers.</p>
              </div>
            ` : `
              <div id="servers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${botGuilds.map(guild => `
                  <div class="server-card group bg-zinc-800 hover:bg-zinc-750 border border-zinc-700 p-6 rounded-lg transition cursor-pointer" onclick="viewGuild('${guild.id}', '${guild.name.replace(/'/g, "\\'")}')">
                    <div class="flex items-start justify-between mb-4">
                      <div class="w-14 h-14 bg-indigo-600 rounded-lg flex items-center justify-center text-2xl font-bold">
                        ${guild.name.charAt(0)}
                      </div>
                      <span class="text-green-400 text-xs font-semibold px-2 py-1 bg-green-600/20 rounded flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                        Active
                      </span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1 truncate">${guild.name}</h3>
                    <p class="text-zinc-500 text-xs font-mono mb-4">ID: ${guild.id}</p>
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm font-medium transition">
                      Manage Server
                    </button>
                  </div>
                `).join('')}
                ${nonBotGuilds.map(guild => {
                  const inviteUrl = 'https://discord.com/api/oauth2/authorize?client_id=' + botClientId + '&permissions=8&scope=bot%20applications.commands&guild_id=' + guild.id;
                  return `
                    <div class="server-card bg-zinc-800 border-2 border-dashed border-zinc-700 p-6 rounded-lg">
                      <div class="flex items-start justify-between mb-4">
                        <div class="w-14 h-14 bg-zinc-700 rounded-lg flex items-center justify-center text-2xl opacity-50 font-bold">
                          ${guild.name.charAt(0)}
                        </div>
                        <span class="text-yellow-400 text-xs font-semibold px-2 py-1 bg-yellow-600/20 rounded">Bot Missing</span>
                      </div>
                      <h3 class="text-xl font-bold text-zinc-300 mb-1 truncate">${guild.name}</h3>
                      <p class="text-zinc-600 text-xs font-mono mb-4">ID: ${guild.id}</p>
                      <a href="${inviteUrl}" target="_blank" class="block text-center bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-medium transition">
                        Add Bot to Server
                      </a>
                    </div>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    let currentGuild = null;
    let currentGuildName = '';
    let currentTab = 'overview';
    let guildData = {};
    let availableLocales = [];

    async function showMainDashboard() {
      if (typeof cleanupConsoleWebSocket !== 'undefined') {
        cleanupConsoleWebSocket();
      }

      const auth = await API.checkAuth();
      if (!auth.authenticated) {
        document.getElementById('app').innerHTML = renderLogin();
        return;
      }
      document.getElementById('app').innerHTML = renderDashboard(auth.user, auth.isOwner, auth.botClientId);
    }

    async function showDashboardSecurity() {
      const auth = await API.checkAuth();
      if (!auth.authenticated) {
        document.getElementById('app').innerHTML = renderLogin();
        return;
      }

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-zinc-800 border-b border-zinc-700 px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
              <h1 class="text-2xl font-bold">Dashboard Security Logs</h1>
              <div class="flex items-center gap-4">
                <button onclick="showMainDashboard()" class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition">
                  ‚Üê Back to Servers
                </button>
                <span class="text-zinc-400">${auth.user.username}${auth.user.discriminator !== '0' ? '#' + auth.user.discriminator : ''}</span>
                <a href="/auth/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition">Logout</a>
              </div>
            </div>
          </nav>

          <div class="container mx-auto p-6">
            ${renderDashboardAuditTab()}
          </div>
        </div>
      `;

      setTimeout(() => {
        loadDashboardAudit();
      }, 100);
    }

    async function showConsole() {
      const auth = await API.checkAuth();
      if (!auth.authenticated) {
        document.getElementById('app').innerHTML = renderLogin();
        return;
      }

      if (typeof cleanupConsoleWebSocket !== 'undefined') {
        cleanupConsoleWebSocket();
      }

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-zinc-800 border-b border-zinc-700 px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
              <h1 class="text-2xl font-bold">Console Logs</h1>
              <div class="flex items-center gap-4">
                <button onclick="showMainDashboard()" class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition">
                  ‚Üê Back to Servers
                </button>
                <span class="text-zinc-400">${auth.user.username}${auth.user.discriminator !== '0' ? '#' + auth.user.discriminator : ''}</span>
                <a href="/auth/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition">Logout</a>
              </div>
            </div>
          </nav>

          ${renderConsoleTab()}
        </div>
      `;

      setTimeout(() => {
        if (typeof initConsoleWebSocket !== 'undefined') {
          initConsoleWebSocket();
        }
      }, 100);
    }

    async function showAccountSettings() {
      const auth = await API.checkAuth();
      if (!auth.authenticated) {
        document.getElementById('app').innerHTML = renderLogin();
        return;
      }

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-zinc-800 border-b border-zinc-700 px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
              <h1 class="text-2xl font-bold">Account Settings</h1>
              <div class="flex items-center gap-4">
                <button onclick="showMainDashboard()" class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition">
                  ‚Üê Back to Dashboard
                </button>
                <span class="text-zinc-400">${auth.user.username}${auth.user.discriminator !== '0' ? '#' + auth.user.discriminator : ''}</span>
                <a href="/auth/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition">Logout</a>
              </div>
            </div>
          </nav>

          <div class="container mx-auto p-6">
            ${renderAccountSettingsPage()}
          </div>
        </div>
      `;

      setTimeout(() => {
        loadUserSettings();
        loadUserSessions();
      }, 100);
    }

    async function viewGuild(guildId, guildName) {
      if (typeof cleanupConsoleWebSocket !== 'undefined') {
        cleanupConsoleWebSocket();
      }

      currentGuild = guildId;
      currentGuildName = guildName;
      window.currentGuildId = guildId;
      currentTab = 'overview';
      await loadGuildData();
      renderGuildDashboard();
    }

    async function loadGuildData() {
      const [config, stats, locales] = await Promise.all([
        API.fetchGuildConfig(currentGuild),
        API.fetchGuildStats(currentGuild),
        availableLocales.length === 0 ? API.fetchLocales() : Promise.resolve({ data: availableLocales })
      ]);
      guildData = { config: config.data, stats: stats.data };
      if (availableLocales.length === 0) {
        availableLocales = locales.data;
      }

      const userIds = stats.data.warnings.recent.map(w => w.user_id);
      await preloadUsers(userIds);
    }

    async function switchTab(tab) {
      if (typeof cleanupMusicPlayer === 'function') {
        cleanupMusicPlayer();
      }

      currentTab = tab;
      if (tab === 'tickets') {
        const tickets = await API.fetchTickets(currentGuild);
        guildData.tickets = tickets.data;
        const userIds = tickets.data.map(t => t.user_id);
        await preloadUsers(userIds);
      } else if (tab === 'warnings') {
        const warnings = await API.fetchWarnings(currentGuild);
        guildData.warnings = warnings.data;
        const userIds = warnings.data.flatMap(w => [w.user_id, w.moderator_id]);
        await preloadUsers(userIds);
      } else if (tab === 'logs') {
        const logs = await API.fetchLogs(currentGuild);
        guildData.logs = logs.data;
        const userIds = logs.data.flatMap(l => [l.moderator_id, l.target_id]);
        await preloadUsers(userIds);
      } else if (tab === 'automod') {
        const automod = await API.fetchAutomod(currentGuild);
        guildData.automod = automod.data || {};
      } else if (tab === 'rules') {
        const rules = await API.fetchRules(currentGuild);
        guildData.rules = rules.data || [];
      }
      renderGuildDashboard();

      if (tab === 'automod') {
        window.customFiltersManager = new CustomFiltersManager(currentGuild);
        await window.customFiltersManager.loadFilters();
        const container = document.getElementById('custom-filters-container');
        if (container) {
          container.innerHTML = window.customFiltersManager.renderFiltersUI();
        }
      } else if (tab === 'xpboosters') {
        window.xpBoostersManager = new XPBoostersManager(currentGuild);
        await window.xpBoostersManager.loadBoosters();
        const container = document.getElementById('xp-boosters-container');
        if (container) {
          container.innerHTML = window.xpBoostersManager.renderBoostersUI();
        }
      } else if (tab === 'music') {
        if (typeof initMusicPlayer === 'function') {
          initMusicPlayer(currentGuild);
        }
      }
    }

    function renderGuildDashboard() {
      const config = guildData.config;
      const allTabs = [
        { id: 'overview', name: 'Overview', icon: 'üìä', enabled: true },
        { id: 'config', name: 'Configuration', icon: '‚öôÔ∏è', enabled: true },
        { id: 'tickets', name: 'Tickets', icon: 'üé´', enabled: !!config.tickets_enabled },
        { id: 'warnings', name: 'Warnings', icon: '‚ö†Ô∏è', enabled: !!config.warnings_enabled },
        { id: 'logs', name: 'Audit Logs', icon: 'üìã', enabled: !!config.moderation_enabled },
        { id: 'automod', name: 'AutoMod', icon: 'üõ°Ô∏è', enabled: !!config.automod_enabled },
        { id: 'rules', name: 'Rules', icon: 'üìú', enabled: !!config.moderation_enabled },
        { id: 'xpboosters', name: 'XP Boosters', icon: '‚ö°', enabled: !!config.leveling_enabled },
        { id: 'music', name: 'Music', icon: 'üéµ', enabled: !!config.music_enabled },
        { id: 'chat', name: 'Live Chat', icon: 'üí¨', enabled: true },
        { id: 'permissions', name: 'Permissions', icon: 'üîí', enabled: true },
        { id: 'appeals', name: 'Appeals', icon: 'üìã', enabled: !!config.moderation_enabled },
        { id: 'analytics', name: 'Analytics', icon: 'üìà', enabled: !!config.analytics_enabled },
        { id: 'bulk', name: 'Bulk Actions', icon: '‚ö°', enabled: !!config.moderation_enabled },
        { id: 'backups', name: 'Backups', icon: 'üíæ', enabled: true }
      ];

      const tabs = allTabs.filter(tab => tab.enabled);

      const currentTabEnabled = allTabs.find(t => t.id === currentTab)?.enabled;
      if (!currentTabEnabled) {
        currentTab = 'overview';
      }

      let content = '';
      if (currentTab === 'overview') content = renderOverviewTab();
      else if (currentTab === 'config') content = renderConfigTab();
      else if (currentTab === 'tickets') content = renderTicketsTab();
      else if (currentTab === 'warnings') content = renderWarningsTab();
      else if (currentTab === 'logs') content = renderLogsTab();
      else if (currentTab === 'automod') content = renderAutomodTab();
      else if (currentTab === 'rules') content = renderRulesTab();
      else if (currentTab === 'xpboosters') content = renderXPBoostersTab();
      else if (currentTab === 'music') content = renderMusicTab();
      else if (currentTab === 'chat') content = renderChatTab();
      else if (currentTab === 'permissions') content = renderPermissionsTab();
      else if (currentTab === 'appeals') content = renderAppealsTab();
      else if (currentTab === 'analytics') content = renderAnalyticsTab();
      else if (currentTab === 'bulk') content = renderBulkTab();
      else if (currentTab === 'backups') content = renderBackupsTab();

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <nav class="bg-zinc-800 border-b border-zinc-700 px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
              <div class="flex items-center gap-4">
                <button onclick="showMainDashboard()" class="text-zinc-400 hover:text-white transition">&larr; Back</button>
                <h1 class="text-2xl font-bold">${currentGuildName}</h1>
              </div>
              <a href="/auth/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm transition">Logout</a>
            </div>
          </nav>

          <div class="border-b border-zinc-700 bg-zinc-800">
            <div class="container mx-auto">
              <nav class="flex gap-1 overflow-x-auto justify-center">
                ${tabs.map(tab => `
                  <button onclick="switchTab('${tab.id}')" class="px-3 py-2 text-xs font-medium transition flex flex-col items-center gap-1 min-w-[80px] ${
                    currentTab === tab.id
                      ? 'text-white border-b-2 border-indigo-500'
                      : 'text-zinc-400 hover:text-white'
                  }">
                    <span class="text-xl">${tab.icon}</span>
                    <span>${tab.name}</span>
                  </button>
                `).join('')}
              </nav>
            </div>
          </div>

          <div class="max-w-7xl mx-auto p-6">
            ${content}
          </div>
        </div>
      `;
    }

    async function viewTicketTranscript(ticketId) {
      try {
        const result = await API.fetchTicketTranscript(currentGuild, ticketId);
        if (!result.success) {
          alert(result.error || 'Failed to load transcript');
          return;
        }

        const messages = result.data;

        const modalHtml = `
          <div id="transcript-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onclick="closeTranscriptModal(event)">
            <div class="bg-zinc-800 rounded-lg w-full max-w-4xl max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
              <div class="p-6 border-b border-zinc-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Ticket #${ticketId} Transcript</h2>
                <div class="flex gap-2 items-center">
                  <button onclick="downloadTranscript(${ticketId})" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm transition">
                    üì• Download
                  </button>
                  <button onclick="closeTranscriptModal()" class="text-zinc-400 hover:text-white text-2xl">&times;</button>
                </div>
              </div>
              <div class="p-6 overflow-y-auto max-h-[calc(80vh-80px)] space-y-4">
                ${messages.length === 0 ? '<p class="text-zinc-400 text-center">No messages found</p>' : messages.map(msg => `
                  <div class="flex gap-3">
                    <img src="${msg.author.avatar}" class="w-10 h-10 rounded-full" alt="${msg.author.username}">
                    <div class="flex-1">
                      <div class="flex items-baseline gap-2 mb-1">
                        <span class="font-bold ${msg.author.bot ? 'text-indigo-400' : 'text-white'}">${msg.author.username}</span>
                        ${msg.author.bot ? '<span class="px-1 py-0.5 text-xs bg-indigo-600 rounded">BOT</span>' : ''}
                        <span class="text-xs text-zinc-500">${new Date(msg.timestamp).toLocaleString()}</span>
                      </div>
                      <div class="text-zinc-300 whitespace-pre-wrap break-words">${msg.content || '<em class="text-zinc-500">No content</em>'}</div>
                      ${msg.attachments.length > 0 ? `
                        <div class="mt-2 space-y-2">
                          ${msg.attachments.map(att => `
                            <div class="flex items-center gap-2 text-sm">
                              ${att.contentType?.startsWith('image/') ? `
                                <img src="${att.url}" class="max-w-sm rounded" alt="${att.name}">
                              ` : `
                                <a href="${att.url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 underline">
                                  üìé ${att.name}
                                </a>
                              `}
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                      ${msg.embeds.length > 0 ? `
                        <div class="mt-2 space-y-2">
                          ${msg.embeds.map(embed => `
                            <div class="border-l-4 border-indigo-500 bg-zinc-900/50 p-3 rounded">
                              ${embed.title ? `<div class="font-bold mb-1">${embed.title}</div>` : ''}
                              ${embed.description ? `<div class="text-sm text-zinc-400">${embed.description}</div>` : ''}
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        const modalElement = modalContainer.firstElementChild;
        modalElement.dataset.ticketId = ticketId;
        modalElement.dataset.messages = JSON.stringify(messages);
        document.body.appendChild(modalElement);
      } catch (error) {
        console.error('Failed to view transcript:', error);
        alert('Failed to load ticket transcript');
      }
    }

    function closeTranscriptModal(event) {
      if (!event || event.target.id === 'transcript-modal' || !event) {
        const modal = document.getElementById('transcript-modal');
        if (modal) modal.remove();
      }
    }

    function downloadTranscript(ticketId) {
      const modal = document.getElementById('transcript-modal');
      if (!modal) return;

      const messages = JSON.parse(modal.dataset.messages || '[]');

      let transcriptText = `Ticket #${ticketId} Transcript\n`;
      transcriptText += `Generated: ${new Date().toLocaleString()}\n`;
      transcriptText += `Server: ${currentGuildName}\n`;
      transcriptText += `${'='.repeat(80)}\n\n`;

      messages.forEach(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleString();
        const username = msg.author.username + (msg.author.bot ? ' [BOT]' : '');

        transcriptText += `[${timestamp}] ${username}\n`;

        if (msg.content) {
          transcriptText += `${msg.content}\n`;
        }

        if (msg.attachments.length > 0) {
          msg.attachments.forEach(att => {
            transcriptText += `üìé Attachment: ${att.name} - ${att.url}\n`;
          });
        }

        if (msg.embeds.length > 0) {
          msg.embeds.forEach(embed => {
            transcriptText += `[Embed]\n`;
            if (embed.title) transcriptText += `Title: ${embed.title}\n`;
            if (embed.description) transcriptText += `${embed.description}\n`;
          });
        }

        transcriptText += '\n';
      });

      const blob = new Blob([transcriptText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ticket-${ticketId}-transcript.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function formatUptime(ms) {
      const days = Math.floor(ms / (24 * 60 * 60 * 1000));
      const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
      const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
      if (days > 0) return `${days}d ${hours}h ${minutes}m`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      return `${minutes}m`;
    }

    function createStatCard(title, value, iconPath, valueColor = 'text-white') {
      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-5 hover:border-zinc-600 transition-colors">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-zinc-400 text-sm font-medium">${title}</h3>
            <svg class="w-5 h-5 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
            </svg>
          </div>
          <p class="text-3xl font-bold ${valueColor}">${value}</p>
        </div>
      `;
    }

    function createSectionCard(title, iconPath, content) {
      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
            </svg>
            ${title}
          </h3>
          ${content}
        </div>
      `;
    }

    function createActionCard(title, description, actionText, tab, iconPath) {
      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-5 hover:border-indigo-500/50 transition-all cursor-pointer group" onclick="switchTab('${tab}')">
          <div class="flex items-start gap-4">
            <div class="p-2 bg-zinc-700 rounded-lg group-hover:bg-indigo-500/20 transition-colors">
              <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="text-white font-medium mb-1">${title}</h4>
              <p class="text-zinc-400 text-sm mb-3">${description}</p>
              <span class="text-indigo-400 text-sm font-medium group-hover:text-indigo-300 transition-colors">
                ${actionText} ‚Üí
              </span>
            </div>
          </div>
        </div>
      `;
    }

    function createMetricCard(label, value, iconPath, iconColor = 'text-zinc-500', badge = null) {
      return `
        <div class="flex items-center justify-between p-4 bg-zinc-700/50 rounded-lg">
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
            </svg>
            <span class="text-zinc-300">${label}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-white font-semibold">${value}</span>
            ${badge ? `<span class="px-2 py-0.5 text-xs rounded-full ${badge.class}">${badge.text}</span>` : ''}
          </div>
        </div>
      `;
    }

    function renderOverviewTab() {
      const stats = guildData.stats;
      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
              <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Server Overview
            </h2>
            <p class="text-zinc-300 text-sm">Monitor your server's activity and performance at a glance</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${createStatCard('Total Tickets', stats.tickets.total, 'M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z')}
            ${createStatCard('Open Tickets', stats.tickets.open, 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', 'text-green-400')}
            ${createStatCard('Total Warnings', stats.warnings.total, 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z', 'text-yellow-400')}
            ${createStatCard('Mod Actions', stats.moderation.total, 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z', 'text-red-400')}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${createActionCard(
              'AutoMod Settings',
              'Configure automated moderation rules and filters',
              'Configure AutoMod',
              'automod',
              'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z'
            )}
            ${createActionCard(
              'Manage Backups',
              'View, create, and restore server backups',
              'View Backups',
              'backups',
              'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12'
            )}
            ${createActionCard(
              'Server Config',
              'Update general server settings and preferences',
              'Open Configuration',
              'config',
              'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z'
            )}
          </div>

          ${stats.health ? `
          <div class="bg-zinc-800 rounded-lg overflow-hidden border ${stats.health.status === 'healthy' ? 'border-green-500/50' : stats.health.status === 'degraded' ? 'border-yellow-500/50' : 'border-red-500/50'}">
            <div class="bg-zinc-900/50 p-6 border-b border-zinc-700">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <svg class="w-8 h-8 ${stats.health.status === 'healthy' ? 'text-green-400' : stats.health.status === 'degraded' ? 'text-yellow-400' : 'text-red-400'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                  <div>
                    <h2 class="text-2xl font-bold text-white">System Health</h2>
                    <p class="text-sm text-zinc-300 mt-1">Real-time monitoring of bot performance</p>
                  </div>
                </div>
                <span class="px-4 py-2 rounded-lg text-sm font-bold uppercase ${stats.health.status === 'healthy' ? 'bg-green-500/20 text-green-300 border border-green-500/50' : stats.health.status === 'degraded' ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/50' : 'bg-red-500/20 text-red-300 border border-red-500/50'}">
                  ${stats.health.status}
                </span>
              </div>
            </div>

            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                ${createMetricCard(
                  'Uptime',
                  formatUptime(stats.health.uptime),
                  'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                  'text-blue-400'
                )}
                <div class="flex items-center justify-between p-4 bg-zinc-700/50 rounded-lg">
                  <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    <span class="text-zinc-300">Memory</span>
                  </div>
                  <div>
                    <div class="text-white font-semibold text-right">${stats.health.memory.used}MB <span class="text-sm text-zinc-400">/ ${stats.health.memory.total}MB</span></div>
                    <div class="w-32 bg-zinc-700 rounded-full h-2 mt-2">
                      <div class="h-2 rounded-full transition-all ${stats.health.memory.percentage > 90 ? 'bg-red-500' : stats.health.memory.percentage > 75 ? 'bg-yellow-500' : 'bg-green-500'}"
                           style="width: ${stats.health.memory.percentage}%"></div>
                    </div>
                    <p class="text-xs text-zinc-400 mt-1 text-right">${stats.health.memory.percentage}% used</p>
                  </div>
                </div>
                ${createMetricCard(
                  'Database',
                  stats.health.database.connected ? 'Connected' : 'Disconnected',
                  'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4',
                  'text-cyan-400',
                  stats.health.database.connected ? { text: `${stats.health.database.responseTime}ms`, class: 'bg-green-500/20 text-green-300' } : null
                )}
                ${createMetricCard(
                  'Discord API',
                  stats.health.discord.connected ? 'Connected' : 'Disconnected',
                  'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z',
                  'text-indigo-400',
                  stats.health.discord.connected ? { text: `${stats.health.discord.ping}ms`, class: 'bg-green-500/20 text-green-300' } : null
                )}
              </div>

              ${stats.health.errors && stats.health.errors.length > 0 ? `
                <div class="bg-red-900/20 border border-red-500/50 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="font-bold text-red-300">Issues Detected</p>
                  </div>
                  <ul class="list-disc list-inside text-sm text-red-200 space-y-1">
                    ${stats.health.errors.map(err => `<li>${err}</li>`).join('')}
                  </ul>
                </div>
              ` : `
                <div class="bg-green-900/20 border border-green-500/50 rounded-lg p-4">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-sm font-medium text-green-300">All systems operational</p>
                  </div>
                </div>
              `}
            </div>
          </div>
          ` : ''}

          ${createSectionCard(
            'Moderation Stats',
            'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z',
            `
              <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-zinc-700/50 rounded">
                  <span class="text-zinc-300 font-medium">Kicks</span>
                  <span class="font-bold text-xl text-white">${stats.moderation.kicks}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-zinc-700/50 rounded">
                  <span class="text-zinc-300 font-medium">Bans</span>
                  <span class="font-bold text-xl text-white">${stats.moderation.bans}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-zinc-700/50 rounded">
                  <span class="text-zinc-300 font-medium">Mutes</span>
                  <span class="font-bold text-xl text-white">${stats.moderation.mutes}</span>
                </div>
              </div>
            `
          )}

          ${createSectionCard(
            'Recent Warnings',
            'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z',
            stats.warnings.recent.length === 0 ? `
              <div class="py-8 text-center">
                <svg class="w-12 h-12 mx-auto mb-3 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-zinc-400 text-sm">No recent warnings</p>
              </div>
            ` : `
              <div class="space-y-3">
                ${stats.warnings.recent.slice(0, 5).map(w => `
                  <div class="flex items-center gap-2 p-3 bg-zinc-700/50 rounded text-sm">
                    ${renderUserTag(w.user_id, true)}
                    <span class="text-zinc-600">‚Ä¢</span>
                    <span class="text-zinc-300 flex-1 truncate">${w.reason || 'No reason'}</span>
                  </div>
                `).join('')}
              </div>
            `
          )}
        </div>
      `;
    }

    function renderConfigTab() {
      const config = guildData.config;
      return `
        <div class="max-w-4xl mx-auto space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h1 class="text-2xl font-bold text-white">Server Configuration</h1>
          </div>
          <form id="config-form" class="space-y-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">‚öôÔ∏è General Settings</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Server Prefix</label>
                  <input type="text" name="prefix" value="${config.prefix || '/'}"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Language</label>
                  <select name="locale" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    ${availableLocales.map(locale => `
                      <option value="${locale.code}" ${config.locale === locale.code ? 'selected' : ''}>
                        ${locale.emoji} ${locale.nativeName}
                      </option>
                    `).join('')}
                  </select>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üß© Modules & Features</h2>
              <p class="text-sm text-zinc-400 mb-4">Enable or disable specific bot features. Disabled modules will be hidden from the dashboard.</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üé´</span>
                    <span class="text-sm font-medium">Ticket System</span>
                  </div>
                  <input type="checkbox" name="tickets_enabled" ${config.tickets_enabled !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">‚ö†Ô∏è</span>
                    <span class="text-sm font-medium">Warnings System</span>
                  </div>
                  <input type="checkbox" name="warnings_enabled" ${config.warnings_enabled !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üìä</span>
                    <span class="text-sm font-medium">Analytics Tracking</span>
                  </div>
                  <input type="checkbox" name="analytics_enabled" ${config.analytics_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üî®</span>
                    <span class="text-sm font-medium">Moderation Features</span>
                  </div>
                  <input type="checkbox" name="moderation_enabled" ${config.moderation_enabled !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üõ°Ô∏è</span>
                    <span class="text-sm font-medium">AutoMod</span>
                  </div>
                  <input type="checkbox" name="automod_enabled" ${config.automod_enabled !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üìà</span>
                    <span class="text-sm font-medium">Leveling/XP System</span>
                  </div>
                  <input type="checkbox" name="leveling_enabled" ${config.leveling_enabled !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üéµ</span>
                    <span class="text-sm font-medium">Music Player</span>
                  </div>
                  <input type="checkbox" name="music_enabled" ${config.music_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üëã Welcome & Goodbye</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Welcome Messages</span>
                  <input type="checkbox" name="welcome_enabled" ${config.welcome_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Welcome Channel ID</label>
                  <input type="text" name="welcome_channel_id" value="${config.welcome_channel_id || ''}" placeholder="Channel ID for welcome messages"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Right-click a channel ‚Üí Copy Channel ID (Developer Mode must be enabled)</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Welcome Message</label>
                  <div class="space-y-2">
                    <div class="flex space-x-2">
                      <button type="button" class="toggle-message-type px-3 py-1.5 text-xs rounded bg-indigo-600 hover:bg-indigo-700" data-type="welcome">
                        Switch to Embed Builder
                      </button>
                    </div>
                    <div class="message-text-editor" data-type="welcome">
                      <textarea name="welcome_message" rows="2"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">${config.welcome_message || 'Welcome {user} to {server}!'}</textarea>
                      <p class="text-xs text-zinc-400 mt-1">Use {user} for user mention and {server} for server name</p>
                    </div>
                    <div class="message-embed-editor hidden" data-type="welcome" id="welcome-embed-builder"></div>
                  </div>
                </div>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Goodbye Messages</span>
                  <input type="checkbox" name="goodbye_enabled" ${config.goodbye_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Goodbye Channel ID</label>
                  <input type="text" name="goodbye_channel_id" value="${config.goodbye_channel_id || ''}" placeholder="Channel ID for goodbye messages"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Right-click a channel ‚Üí Copy Channel ID (Developer Mode must be enabled)</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Goodbye Message</label>
                  <div class="space-y-2">
                    <div class="flex space-x-2">
                      <button type="button" class="toggle-message-type px-3 py-1.5 text-xs rounded bg-indigo-600 hover:bg-indigo-700" data-type="goodbye">
                        Switch to Embed Builder
                      </button>
                    </div>
                    <div class="message-text-editor" data-type="goodbye">
                      <textarea name="goodbye_message" rows="2"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">${config.goodbye_message || '{user} has left the server.'}</textarea>
                      <p class="text-xs text-zinc-400 mt-1">Use {user} for username and {server} for server name</p>
                    </div>
                    <div class="message-embed-editor hidden" data-type="goodbye" id="goodbye-embed-builder"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üìà Leveling & XP System</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable XP System</span>
                  <input type="checkbox" name="xp_enabled" ${config.xp_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">Min XP per Message</label>
                    <input type="number" name="xp_min" value="${config.xp_min || 15}" min="1"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Max XP per Message</label>
                    <input type="number" name="xp_max" value="${config.xp_max || 25}" min="1"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">XP Cooldown (seconds)</label>
                    <input type="number" name="xp_cooldown" value="${config.xp_cooldown || 60}" min="0"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  </div>
                </div>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Level Up Messages</span>
                  <input type="checkbox" name="level_up_enabled" ${config.level_up_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Level Up Channel ID</label>
                  <input type="text" name="level_up_channel_id" value="${config.level_up_channel_id || ''}" placeholder="Channel ID for level up messages (leave empty for current channel)"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Optional: Specify a channel for level up messages, or leave empty to send in the user's current channel</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Level Up Message</label>
                  <textarea name="level_up_message" rows="2"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">${config.level_up_message || 'Congratulations {user}! You reached level {level}!'}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">Use {user} for user mention and {level} for new level</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üõ°Ô∏è Moderation</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Mod Log Channel ID</label>
                  <input type="text" name="mod_log_channel_id" value="${config.mod_log_channel_id || ''}" placeholder="Channel ID for moderation logs"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Channel where moderation actions (warns, kicks, bans) will be logged</p>
                </div>
                <div>
                  <h3 class="text-sm font-medium mb-3">Warning Threshold</h3>
                  <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded mb-3">
                    <span class="text-sm">Enable Warning Auto-Action</span>
                    <input type="checkbox" name="warning_threshold_enabled" ${config.warning_threshold_enabled ? 'checked' : ''} class="w-4 h-4">
                  </label>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-medium mb-2">Warning Count</label>
                      <input type="number" name="warning_threshold_count" value="${config.warning_threshold_count || 3}" min="1"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Action</label>
                      <select name="warning_threshold_action" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                        <option value="mute" ${config.warning_threshold_action === 'mute' ? 'selected' : ''}>Mute</option>
                        <option value="kick" ${config.warning_threshold_action === 'kick' ? 'selected' : ''}>Kick</option>
                        <option value="ban" ${config.warning_threshold_action === 'ban' ? 'selected' : ''}>Ban</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Duration (seconds)</label>
                      <input type="number" name="warning_threshold_duration" value="${config.warning_threshold_duration || 3600}" min="0"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    </div>
                  </div>
                </div>
                <div>
                  <h3 class="text-sm font-medium mb-3">Anti-Raid Protection</h3>
                  <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded mb-3">
                    <span class="text-sm">Enable Anti-Raid</span>
                    <input type="checkbox" name="antiraid_enabled" ${config.antiraid_enabled ? 'checked' : ''} class="w-4 h-4">
                  </label>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label class="block text-sm font-medium mb-2">Join Threshold</label>
                      <input type="number" name="antiraid_join_threshold" value="${config.antiraid_join_threshold || 5}" min="1"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Time Window (seconds)</label>
                      <input type="number" name="antiraid_join_window" value="${config.antiraid_join_window || 10}" min="1"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Action</label>
                      <select name="antiraid_action" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                        <option value="kick" ${config.antiraid_action === 'kick' ? 'selected' : ''}>Kick</option>
                        <option value="ban" ${config.antiraid_action === 'ban' ? 'selected' : ''}>Ban</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tickets Module -->
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üé´ Ticket System</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Ticket Category ID</label>
                  <input type="text" name="ticket_category_id" value="${config.ticket_category_id || ''}" placeholder="Category ID for ticket channels"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Right-click a category ‚Üí Copy Category ID (Developer Mode must be enabled)</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Support Role ID</label>
                  <input type="text" name="ticket_support_role_id" value="${config.ticket_support_role_id || ''}" placeholder="Role ID for ticket support staff"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Right-click a role ‚Üí Copy Role ID</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Ticket Log Channel ID</label>
                  <input type="text" name="ticket_log_channel_id" value="${config.ticket_log_channel_id || ''}" placeholder="Channel ID for ticket logs"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Channel where ticket transcripts and logs will be sent</p>
                </div>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Send Transcript to User via DM</span>
                  <input type="checkbox" name="ticket_dm_transcript" ${config.ticket_dm_transcript !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Ticket Open Message</label>
                  <div class="space-y-2">
                    <div class="flex space-x-2">
                      <button type="button" class="toggle-message-type px-3 py-1.5 text-xs rounded bg-indigo-600 hover:bg-indigo-700" data-type="ticket-open">
                        Switch to Embed Builder
                      </button>
                    </div>
                    <div class="message-text-editor" data-type="ticket-open">
                      <textarea name="ticket_open_message" rows="4"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.ticket_open_message || 'Welcome {user}!\\n\\n**Subject:** {subject}\\n\\nA staff member will be with you shortly. Please describe your issue in detail.'}</textarea>
                      <p class="text-xs text-zinc-400 mt-1">Use {user} for user mention, {subject} for ticket subject. Use \\n for line breaks.</p>
                    </div>
                    <div class="message-embed-editor hidden" data-type="ticket-open" id="ticket-open-embed-builder"></div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Ticket Close Message</label>
                  <div class="space-y-2">
                    <div class="flex space-x-2">
                      <button type="button" class="toggle-message-type px-3 py-1.5 text-xs rounded bg-indigo-600 hover:bg-indigo-700" data-type="ticket-close">
                        Switch to Embed Builder
                      </button>
                    </div>
                    <div class="message-text-editor" data-type="ticket-close">
                      <textarea name="ticket_close_message" rows="2"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.ticket_close_message || 'This ticket has been closed by {closer}.'}</textarea>
                      <p class="text-xs text-zinc-400 mt-1">Use {closer} for the staff member who closed the ticket</p>
                    </div>
                    <div class="message-embed-editor hidden" data-type="ticket-close" id="ticket-close-embed-builder"></div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">DM Transcript Message</label>
                  <div class="space-y-2">
                    <div class="flex space-x-2">
                      <button type="button" class="toggle-message-type px-3 py-1.5 text-xs rounded bg-indigo-600 hover:bg-indigo-700" data-type="ticket-dm">
                        Switch to Embed Builder
                      </button>
                    </div>
                    <div class="message-text-editor" data-type="ticket-dm">
                      <textarea name="ticket_dm_message" rows="4"
                        class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.ticket_dm_message || 'Your ticket in **{server}** has been closed.\\n\\n**Subject:** {subject}\\n**Closed by:** {closer}\\n\\nA transcript of your ticket has been attached for your records.'}</textarea>
                      <p class="text-xs text-zinc-400 mt-1">Use {user} for user mention, {server} for server name, {subject} for ticket subject, {closer} for closer tag. Use \\n for line breaks.</p>
                    </div>
                    <div class="message-embed-editor hidden" data-type="ticket-dm" id="ticket-dm-embed-builder"></div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">Max Open Tickets per User</label>
                    <input type="number" name="ticket_max_open" value="${config.ticket_max_open || 1}" min="1" max="10"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">Maximum number of open tickets a user can have at once</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Ticket Naming Format</label>
                    <select name="ticket_naming_format" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                      <option value="username" ${config.ticket_naming_format === 'username' ? 'selected' : ''}>ticket-username</option>
                      <option value="number" ${config.ticket_naming_format === 'number' ? 'selected' : ''}>ticket-1</option>
                    </select>
                    <p class="text-xs text-zinc-400 mt-1">Format for ticket channel names</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Logging Module -->
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üìù Logging</h2>
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Audit Log Channel ID</label>
                <input type="text" name="audit_log_channel_id" value="${config.audit_log_channel_id || ''}" placeholder="Channel ID for audit logs"
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                <p class="text-xs text-zinc-400 mt-1">Right-click a channel ‚Üí Copy Channel ID (Developer Mode must be enabled)</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Message Edits</span>
                  <input type="checkbox" name="log_message_edits" ${config.log_message_edits ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Message Deletes</span>
                  <input type="checkbox" name="log_message_deletes" ${config.log_message_deletes ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Member Join</span>
                  <input type="checkbox" name="log_member_join" ${config.log_member_join ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Member Leave</span>
                  <input type="checkbox" name="log_member_leave" ${config.log_member_leave ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Role Changes</span>
                  <input type="checkbox" name="log_role_changes" ${config.log_role_changes ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Voice Activity</span>
                  <input type="checkbox" name="log_voice_activity" ${config.log_voice_activity ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Channel Events</span>
                  <input type="checkbox" name="log_channel_events" ${config.log_channel_events ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Server Events</span>
                  <input type="checkbox" name="log_server_events" ${config.log_server_events ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Role Events</span>
                  <input type="checkbox" name="log_role_events" ${config.log_role_events ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Ban Events</span>
                  <input type="checkbox" name="log_ban_events" ${config.log_ban_events ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm">Log Invite Events</span>
                  <input type="checkbox" name="log_invite_events" ${config.log_invite_events ? 'checked' : ''} class="w-4 h-4">
                </label>
              </div>
            </div>

            <!-- Starboard Module -->
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">‚≠ê Starboard</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Starboard Channel ID</label>
                  <input type="text" name="starboard_channel_id" value="${config.starboard_channel_id || ''}" placeholder="Channel ID for starboard"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Channel where starred messages will be posted</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Star Threshold</label>
                  <input type="number" name="starboard_threshold" value="${config.starboard_threshold || 3}" min="1"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Number of ‚≠ê reactions needed</p>
                </div>
              </div>
            </div>

            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded font-medium transition w-full md:w-auto">
              Save All Changes
            </button>
          </form>
        </div>
      `;
    }

    function renderTicketsTab() {
      const tickets = guildData.tickets || [];
      const openTickets = tickets.filter(t => t.status === 'open');
      const closedTickets = tickets.filter(t => t.status === 'closed');

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
          <div class="p-6 border-b border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-white">Tickets</h2>
              <div class="flex gap-2">
                <button onclick="filterTickets('all')" id="filter-all" class="px-4 py-2 text-sm rounded transition bg-indigo-600 text-white">
                  All (${tickets.length})
                </button>
                <button onclick="filterTickets('open')" id="filter-open" class="px-4 py-2 text-sm rounded transition bg-zinc-700 text-zinc-300 hover:bg-zinc-600">
                  Open (${openTickets.length})
                </button>
                <button onclick="filterTickets('closed')" id="filter-closed" class="px-4 py-2 text-sm rounded transition bg-zinc-700 text-zinc-300 hover:bg-zinc-600">
                  Closed (${closedTickets.length})
                </button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-zinc-900">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">User</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Subject</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Created</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Closed</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="tickets-tbody" class="divide-y divide-zinc-700">
                ${tickets.length === 0 ? '<tr><td colspan="7" class="px-6 py-8 text-center text-zinc-400">No tickets found</td></tr>' : tickets.map(t => `
                  <tr class="hover:bg-zinc-750 ticket-row" data-status="${t.status}">
                    <td class="px-6 py-4 text-sm font-mono">#${t.id}</td>
                    <td class="px-6 py-4 text-sm">${renderUserTag(t.user_id, true)}</td>
                    <td class="px-6 py-4 text-sm">${t.subject || 'No subject'}</td>
                    <td class="px-6 py-4 text-sm">
                      <span class="px-2 py-1 text-xs rounded ${t.status === 'open' ? 'bg-green-900/30 text-green-400 border border-green-500/30' : 'bg-red-900/30 text-red-400 border border-red-500/30'}">
                        ${t.status === 'open' ? 'üü¢ Open' : 'üî¥ Closed'}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-zinc-400">${new Date(t.created_at * 1000).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-sm text-zinc-400">${t.closed_at ? new Date(t.closed_at * 1000).toLocaleDateString() : '-'}</td>
                    <td class="px-6 py-4 text-sm">
                      <button onclick="viewTicketTranscript(${t.id})" class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 rounded transition-colors">
                        üìú View ${t.status === 'closed' ? 'Transcript' : 'Messages'}
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function filterTickets(status) {
      const allRows = document.querySelectorAll('.ticket-row');
      const filterButtons = ['filter-all', 'filter-open', 'filter-closed'];

      filterButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.classList.remove('bg-indigo-600', 'text-white');
          btn.classList.add('bg-zinc-700', 'text-zinc-300', 'hover:bg-zinc-600');
        }
      });

      const activeBtn = document.getElementById('filter-' + status);
      if (activeBtn) {
        activeBtn.classList.remove('bg-zinc-700', 'text-zinc-300', 'hover:bg-zinc-600');
        activeBtn.classList.add('bg-indigo-600', 'text-white');
      }

      allRows.forEach(row => {
        if (status === 'all') {
          row.style.display = '';
        } else {
          row.style.display = row.dataset.status === status ? '' : 'none';
        }
      });
    }

    function renderWarningsTab() {
      const warnings = guildData.warnings || [];
      setTimeout(() => {
        const searchInput = document.getElementById('warnings-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            filterWarnings(e.target.value.toLowerCase());
          });
        }
      }, 100);

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
          <div class="p-6 border-b border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-white">All Warnings</h2>
              <div class="flex-1 max-w-md ml-6">
                <input
                  type="text"
                  id="warnings-search"
                  placeholder="Search by User ID, Moderator ID, or Reason..."
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                />
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-zinc-900">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">User</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Moderator</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Reason</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Action</th>
                </tr>
              </thead>
              <tbody id="warnings-tbody" class="divide-y divide-zinc-700">
                ${warnings.length === 0 ? '<tr><td colspan="6" class="px-6 py-8 text-center text-zinc-400">No warnings found</td></tr>' : warnings.map(w => `
                  <tr class="hover:bg-zinc-750 warning-row" data-user-id="${w.user_id}" data-moderator-id="${w.moderator_id}" data-reason="${(w.reason || '').toLowerCase()}">
                    <td class="px-6 py-4 text-sm font-mono">#${w.id}</td>
                    <td class="px-6 py-4 text-sm">${renderUserTag(w.user_id, true)}</td>
                    <td class="px-6 py-4 text-sm">${renderUserTag(w.moderator_id)}</td>
                    <td class="px-6 py-4 text-sm">${w.reason || 'No reason'}</td>
                    <td class="px-6 py-4 text-sm text-zinc-400">${new Date(w.created_at * 1000).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-sm">
                      <button onclick="removeWarning(${w.id})" class="text-red-400 hover:text-red-300 text-xs">Remove</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderLogsTab() {
      const logs = guildData.logs || [];
      setTimeout(() => {
        const searchInput = document.getElementById('logs-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            filterLogs(e.target.value.toLowerCase());
          });
        }
      }, 100);

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
          <div class="p-6 border-b border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-white">Audit Logs</h2>
              <div class="flex-1 max-w-md ml-6">
                <input
                  type="text"
                  id="logs-search"
                  placeholder="Search by Action, Moderator ID, Target ID, or Reason..."
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                />
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-zinc-900">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Action</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Moderator</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Target</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Reason</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase">Date</th>
                </tr>
              </thead>
              <tbody id="logs-tbody" class="divide-y divide-zinc-700">
                ${logs.length === 0 ? '<tr><td colspan="5" class="px-6 py-8 text-center text-zinc-400">No logs found</td></tr>' : logs.map(log => `
                  <tr class="hover:bg-zinc-750 log-row" data-action="${(log.action_type || '').toLowerCase()}" data-moderator-id="${log.moderator_id}" data-target-id="${log.target_id || ''}" data-reason="${(log.reason || '').toLowerCase()}">
                    <td class="px-6 py-4 text-sm">
                      <span class="px-2 py-1 text-xs rounded bg-zinc-700">${formatActionType(log.action_type)}</span>
                    </td>
                    <td class="px-6 py-4 text-sm">${renderUserTag(log.moderator_id)}</td>
                    <td class="px-6 py-4 text-sm">${log.target_id ? renderUserTag(log.target_id) : '<span class="text-zinc-500">N/A</span>'}</td>
                    <td class="px-6 py-4 text-sm">${log.reason || 'No reason provided'}</td>
                    <td class="px-6 py-4 text-sm text-zinc-400">${new Date(log.timestamp * 1000).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderAutomodTab() {
      setTimeout(() => {
        if (!window.securityManager) {
          window.securityManager = new SecurityManager();
        }
        window.securityManager.init();
      }, 100);

      const automod = guildData.automod || {};
      const config = guildData.config || {};
      return `
        <div class="max-w-4xl mx-auto space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h1 class="text-2xl font-bold text-white">AutoMod Configuration</h1>
          </div>

          <form id="automod-form" class="space-y-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üö´ Spam Detection</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Spam Detection</span>
                  <input type="checkbox" name="spam_enabled" ${automod.spam_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">Messages Count</label>
                    <input type="number" name="spam_threshold" value="${automod.spam_threshold || 5}" min="3" max="10"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">Number of duplicate messages to trigger spam filter</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Time Window (seconds)</label>
                    <input type="number" name="spam_interval" value="${automod.spam_interval || 5}" min="3" max="30"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">Time window to detect spam messages</p>
                  </div>
                </div>
                <div class="border-t border-zinc-700 pt-4 mt-4">
                  <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                    <div>
                      <span class="text-sm font-medium block">Similar Message Detection</span>
                      <span class="text-xs text-zinc-400">Detect spam using similar (not identical) messages</span>
                    </div>
                    <input type="checkbox" name="spam_similarity_enabled" ${automod.spam_similarity_enabled ? 'checked' : ''} class="w-4 h-4">
                  </label>
                  <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Similarity Threshold (%)</label>
                    <input type="number" name="spam_similarity_threshold" value="${automod.spam_similarity_threshold || 80}" min="50" max="100"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">How similar messages must be to trigger (80% = very similar)</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üîó Link Filtering</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Link Filtering</span>
                  <input type="checkbox" name="links_enabled" ${automod.links_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Allowed Domains</label>
                  <textarea name="automod_allowed_links" rows="4" placeholder="youtube.com&#10;twitter.com&#10;github.com"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.automod_allowed_links || ''}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">One domain per line. Users can post links from these domains. Leave empty to block all links.</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üì¢ Caps Lock Detection</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Caps Detection</span>
                  <input type="checkbox" name="caps_enabled" ${automod.caps_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">Caps Percentage (%)</label>
                    <input type="number" name="automod_caps_percentage" value="${config.automod_caps_percentage || 70}" min="50" max="100"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">Percentage of caps to trigger filter (default: 70%)</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Minimum Message Length</label>
                    <input type="number" name="automod_caps_min_length" value="${config.automod_caps_min_length || 10}" min="5" max="50"
                      class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <p class="text-xs text-zinc-400 mt-1">Minimum characters to check for caps (default: 10)</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">@ Mention Spam</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Mention Spam Detection</span>
                  <input type="checkbox" name="mentions_enabled" ${automod.mentions_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Maximum Mentions</label>
                  <input type="number" name="automod_max_mentions" value="${config.automod_max_mentions || 5}" min="1" max="20"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">Maximum number of @mentions allowed in a single message</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">ü§¨ Profanity Filter</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Enable Profanity Filter</span>
                  <input type="checkbox" name="profanity_enabled" ${automod.profanity_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Profanity Preset</label>
                  <select name="automod_profanity_preset" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <option value="off" ${(config.automod_profanity_preset || 'moderate') === 'off' ? 'selected' : ''}>Off - No preset filtering</option>
                    <option value="slurs_only" ${(config.automod_profanity_preset || 'moderate') === 'slurs_only' ? 'selected' : ''}>Slurs Only - Only slurs and hate speech</option>
                    <option value="moderate" ${(config.automod_profanity_preset || 'moderate') === 'moderate' ? 'selected' : ''}>Moderate - Most profanity and all slurs (Default)</option>
                    <option value="strict" ${(config.automod_profanity_preset || 'moderate') === 'strict' ? 'selected' : ''}>Strict - All profanity, slurs, and sexual content</option>
                  </select>
                  <p class="text-xs text-zinc-400 mt-1">Choose a built-in profanity filter preset. This will be combined with your custom list below.</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Custom Profanity List</label>
                  <textarea name="automod_profanity_list" rows="6" placeholder="badword1&#10;badword2&#10;badword3"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.automod_profanity_list || ''}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">One word per line. Add custom words/phrases to filter. Case-insensitive.</p>
                  <p class="text-xs text-yellow-400 mt-2">üí° Custom words are added ON TOP of the selected preset above.</p>
                </div>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div>
                    <span class="text-sm font-medium block">Use Word Boundaries</span>
                    <span class="text-xs text-zinc-400">Prevents false positives like "class" containing "ass"</span>
                  </div>
                  <input type="checkbox" name="profanity_use_word_boundaries" ${automod.profanity_use_word_boundaries !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üì® Invite Blocking</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Block Discord Invites</span>
                  <input type="checkbox" name="invites_enabled" ${automod.invites_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <span class="text-sm font-medium">Allow Own Server Invites</span>
                  <input type="checkbox" name="invites_allow_own" ${automod.invites_allow_own !== false ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Allowed Server IDs</label>
                  <textarea name="automod_allow_invites_list" rows="4" placeholder="123456789012345678&#10;987654321098765432"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${config.automod_allow_invites_list || ''}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">One server ID per line. Invites to these servers will be allowed. Leave empty to block all invites.</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üé£ Phishing Detection</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div>
                    <span class="text-sm font-medium block">Enable Phishing Detection</span>
                    <span class="text-xs text-zinc-400">Blocks known phishing/scam links automatically</span>
                  </div>
                  <input type="checkbox" id="phishing-enabled" name="phishing_enabled" ${automod.phishing_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Action for Phishing Links</label>
                  <select id="phishing-action" name="phishing_action" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <option value="warn" ${(automod.phishing_action || 'warn') === 'warn' ? 'selected' : ''}>Warn User</option>
                    <option value="timeout" ${automod.phishing_action === 'timeout' ? 'selected' : ''}>Timeout (5 min)</option>
                    <option value="kick" ${automod.phishing_action === 'kick' ? 'selected' : ''}>Kick User</option>
                    <option value="ban" ${automod.phishing_action === 'ban' ? 'selected' : ''}>Ban User</option>
                  </select>
                  <p class="text-xs text-zinc-400 mt-1">Detects discord-nitro scams, fake steam links, and other phishing attempts.</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üìÖ Account Age Requirement</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div>
                    <span class="text-sm font-medium block">Enable Account Age Check</span>
                    <span class="text-xs text-zinc-400">Auto-kicks accounts below minimum age</span>
                  </div>
                  <input type="checkbox" id="account-age-enabled" name="account_age_enabled" ${automod.account_age_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Minimum Account Age (days)</label>
                  <input type="number" id="account-age-min-days" name="account_age_min_days" value="${automod.account_age_min_days || 7}" min="1" max="365"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                  <p class="text-xs text-zinc-400 mt-1">New members must have Discord accounts at least this old.</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Action for New Accounts</label>
                  <select id="account-age-action" name="account_age_action" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <option value="kick" ${(automod.account_age_action || 'kick') === 'kick' ? 'selected' : ''}>Kick User</option>
                    <option value="ban" ${automod.account_age_action === 'ban' ? 'selected' : ''}>Ban User</option>
                  </select>
                  <p class="text-xs text-zinc-400 mt-1">User receives a DM explaining the requirement before being removed.</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üîç Alt Account Detection</h2>
              <div class="space-y-4">
                <label class="flex items-center justify-between p-3 bg-zinc-700/50 rounded">
                  <div>
                    <span class="text-sm font-medium block">Enable Alt Detection</span>
                    <span class="text-xs text-zinc-400">Flags suspicious accounts with AI scoring</span>
                  </div>
                  <input type="checkbox" id="alt-detection-enabled" name="alt_detection_enabled" ${automod.alt_detection_enabled ? 'checked' : ''} class="w-4 h-4">
                </label>
                <div>
                  <label class="block text-sm font-medium mb-2">Detection Sensitivity</label>
                  <select id="alt-detection-sensitivity" name="alt_detection_sensitivity" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <option value="1" ${automod.alt_detection_sensitivity === 1 ? 'selected' : ''}>1 - Very Strict (70+ score)</option>
                    <option value="2" ${automod.alt_detection_sensitivity === 2 ? 'selected' : ''}>2 - Strict (50+ score)</option>
                    <option value="3" ${(automod.alt_detection_sensitivity || 3) === 3 ? 'selected' : ''}>3 - Medium (35+ score) - Recommended</option>
                    <option value="4" ${automod.alt_detection_sensitivity === 4 ? 'selected' : ''}>4 - Lenient (25+ score)</option>
                    <option value="5" ${automod.alt_detection_sensitivity === 5 ? 'selected' : ''}>5 - Very Lenient (15+ score)</option>
                  </select>
                  <p class="text-xs text-zinc-400 mt-1">Lower sensitivity = more suspicious accounts flagged.</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Action for Critical Risk</label>
                  <select id="alt-detection-action" name="alt_detection_action" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500">
                    <option value="warn" ${(automod.alt_detection_action || 'warn') === 'warn' ? 'selected' : ''}>Warn Only (Log to Mod Channel)</option>
                    <option value="kick" ${automod.alt_detection_action === 'kick' ? 'selected' : ''}>Kick User</option>
                    <option value="ban" ${automod.alt_detection_action === 'ban' ? 'selected' : ''}>Ban User</option>
                  </select>
                  <p class="text-xs text-zinc-400 mt-1">Only applies to critical risk accounts. All flagged accounts are logged.</p>
                </div>
                <div class="bg-zinc-900 p-3 rounded border border-zinc-700">
                  <p class="text-xs text-zinc-300 font-medium mb-2">ü§ñ Detection Factors:</p>
                  <ul class="text-xs text-zinc-400 space-y-1 ml-4">
                    <li>‚Ä¢ Account age (<1 day, <7 days, <30 days)</li>
                    <li>‚Ä¢ Default Discord avatar</li>
                    <li>‚Ä¢ Suspicious username patterns</li>
                    <li>‚Ä¢ Rapid joins from same invite</li>
                    <li>‚Ä¢ Similar usernames to recent joins</li>
                    <li>‚Ä¢ Joining during active raid</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üîí Raid Lockdown</h2>
              <div class="space-y-4">
                <div id="lockdown-status" class="p-4 rounded-lg border-2 status-success">
                  <div class="flex items-center justify-between mb-2">
                    <span id="lockdown-status-text" class="font-bold text-lg">Lockdown Inactive</span>
                    <button type="button" id="lockdown-toggle-btn" class="btn-warning px-4 py-2 rounded font-medium transition">
                      Enable Lockdown
                    </button>
                  </div>
                  <p id="lockdown-time" class="text-sm text-zinc-400">Not active</p>
                </div>
                <div class="bg-zinc-900 p-3 rounded border border-zinc-700">
                  <p class="text-xs text-zinc-300 font-medium mb-2">‚ÑπÔ∏è What is Lockdown Mode?</p>
                  <ul class="text-xs text-zinc-400 space-y-1 ml-4">
                    <li>‚Ä¢ Automatically activates when mass joins detected</li>
                    <li>‚Ä¢ Enhanced security measures for new members</li>
                    <li>‚Ä¢ Manual control available via this button</li>
                    <li>‚Ä¢ Can also be controlled with <code>/automod lockdown</code> command</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold mb-4">üõ°Ô∏è Exemptions</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Exempt Roles</label>
                  <textarea name="exempt_roles" rows="3" placeholder="Role IDs (one per line or comma-separated)&#10;123456789012345678&#10;987654321098765432"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${(automod.exempt_roles || '').split(',').map(r => r.trim()).filter(r => r.length > 0).join('\n')}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">Users with these roles bypass all auto-moderation (in addition to Administrators).</p>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Exempt Channels</label>
                  <textarea name="exempt_channels" rows="3" placeholder="Channel IDs (one per line or comma-separated)&#10;123456789012345678&#10;987654321098765432"
                    class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-sm">${(automod.exempt_channels || '').split(',').map(c => c.trim()).filter(c => c.length > 0).join('\n')}</textarea>
                  <p class="text-xs text-zinc-400 mt-1">Auto-moderation is disabled in these channels.</p>
                </div>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 px-8 py-3 rounded font-medium transition">
                üíæ Save AutoMod Settings
              </button>
            </div>
          </form>

          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6 mt-6">
            <div id="custom-filters-container"></div>
          </div>
        </div>
      `;
    }

    function renderRulesTab() {
      const rules = guildData.rules || [];
      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Add New Rule</h2>
            <form id="add-rule-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Rule Title</label>
                <input type="text" name="title" required class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Description</label>
                <textarea name="description" required rows="3" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2"></textarea>
              </div>
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded font-medium transition">
                Add Rule
              </button>
            </form>
          </div>

          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Server Rules</h2>
            ${rules.length === 0 ? '<p class="text-zinc-400">No rules configured</p>' : `
              <div class="space-y-4">
                ${rules.map(rule => `
                  <div class="border border-zinc-700 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                      <div>
                        <h3 class="font-bold">Rule #${rule.rule_number}: ${rule.title}</h3>
                        <p class="text-sm text-zinc-400 mt-1">${rule.description}</p>
                      </div>
                      <button onclick="deleteRule(${rule.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderXPBoostersTab() {
      return `
        <div class="max-w-6xl mx-auto space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div>
              <h1 class="text-2xl font-bold text-white">XP Multiplier Management</h1>
              <p class="text-zinc-400 mt-1">Configure XP boosters for roles and channels</p>
            </div>
          </div>

          <div id="xp-boosters-container">
            <div class="flex items-center justify-center py-12">
              <div class="text-zinc-400">Loading XP boosters...</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMusicTab() {
      return `
        <div class="max-w-7xl mx-auto space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <h1 class="text-2xl font-bold text-white">Music Player</h1>
            <p class="text-zinc-400 mt-1">Control music playback and configure settings</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold text-white mb-4">Now Playing & Queue</h2>
              <div id="music-queue">
                <div class="flex items-center justify-center py-12">
                  <div class="text-zinc-400">Loading music queue...</div>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h2 class="text-xl font-bold text-white mb-4">Music Settings</h2>
              <div id="music-settings">
                <div class="flex items-center justify-center py-12">
                  <div class="text-zinc-400">Loading music settings...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function removeWarning(warningId) {
      if (!confirm('Are you sure you want to remove this warning?')) return;
      const result = await API.deleteWarning(currentGuild, warningId);
      if (result.success) {
        await switchTab('warnings');
      }
    }

    async function deleteRule(ruleId) {
      if (!confirm('Are you sure you want to delete this rule?')) return;
      const result = await API.deleteRule(currentGuild, ruleId);
      if (result.success) {
        await switchTab('rules');
      }
    }

    document.addEventListener('submit', async (e) => {
      if (e.target.id === 'config-form') {
        e.preventDefault();
        const formData = new FormData(e.target);
        const config = {
          prefix: formData.get('prefix'),
          locale: formData.get('locale'),
          welcome_enabled: formData.get('welcome_enabled') === 'on',
          welcome_channel_id: formData.get('welcome_channel_id') || null,
          welcome_message: formData.get('welcome_message'),
          goodbye_enabled: formData.get('goodbye_enabled') === 'on',
          goodbye_channel_id: formData.get('goodbye_channel_id') || null,
          goodbye_message: formData.get('goodbye_message'),
          xp_enabled: formData.get('xp_enabled') === 'on',
          xp_min: parseInt(formData.get('xp_min')) || 15,
          xp_max: parseInt(formData.get('xp_max')) || 25,
          xp_cooldown: parseInt(formData.get('xp_cooldown')) || 60,
          level_up_enabled: formData.get('level_up_enabled') === 'on',
          level_up_channel_id: formData.get('level_up_channel_id') || null,
          level_up_message: formData.get('level_up_message'),
          warning_threshold_enabled: formData.get('warning_threshold_enabled') === 'on',
          warning_threshold_count: parseInt(formData.get('warning_threshold_count')) || 3,
          warning_threshold_action: formData.get('warning_threshold_action'),
          warning_threshold_duration: parseInt(formData.get('warning_threshold_duration')) || 3600,
          antiraid_enabled: formData.get('antiraid_enabled') === 'on',
          antiraid_join_threshold: parseInt(formData.get('antiraid_join_threshold')) || 5,
          antiraid_join_window: parseInt(formData.get('antiraid_join_window')) || 10,
          antiraid_action: formData.get('antiraid_action'),
          mod_log_channel_id: formData.get('mod_log_channel_id') || null,
          ticket_category_id: formData.get('ticket_category_id') || null,
          ticket_support_role_id: formData.get('ticket_support_role_id') || null,
          ticket_log_channel_id: formData.get('ticket_log_channel_id') || null,
          ticket_dm_transcript: formData.get('ticket_dm_transcript') === 'on',
          ticket_open_message: formData.get('ticket_open_message'),
          ticket_close_message: formData.get('ticket_close_message'),
          ticket_dm_message: formData.get('ticket_dm_message'),
          welcome_embed: window.embedBuilders?.welcome?.getData() ? JSON.stringify(window.embedBuilders.welcome.getData()) : null,
          goodbye_embed: window.embedBuilders?.goodbye?.getData() ? JSON.stringify(window.embedBuilders.goodbye.getData()) : null,
          ticket_open_embed: window.embedBuilders?.ticketOpen?.getData() ? JSON.stringify(window.embedBuilders.ticketOpen.getData()) : null,
          ticket_close_embed: window.embedBuilders?.ticketClose?.getData() ? JSON.stringify(window.embedBuilders.ticketClose.getData()) : null,
          ticket_dm_embed: window.embedBuilders?.ticketDm?.getData() ? JSON.stringify(window.embedBuilders.ticketDm.getData()) : null,
          ticket_max_open: parseInt(formData.get('ticket_max_open')) || 1,
          ticket_naming_format: formData.get('ticket_naming_format'),
          audit_log_channel_id: formData.get('audit_log_channel_id') || null,
          log_message_edits: formData.get('log_message_edits') === 'on',
          log_message_deletes: formData.get('log_message_deletes') === 'on',
          log_member_join: formData.get('log_member_join') === 'on',
          log_member_leave: formData.get('log_member_leave') === 'on',
          log_role_changes: formData.get('log_role_changes') === 'on',
          log_voice_activity: formData.get('log_voice_activity') === 'on',
          log_channel_events: formData.get('log_channel_events') === 'on',
          log_server_events: formData.get('log_server_events') === 'on',
          log_role_events: formData.get('log_role_events') === 'on',
          log_ban_events: formData.get('log_ban_events') === 'on',
          log_invite_events: formData.get('log_invite_events') === 'on',
          starboard_channel_id: formData.get('starboard_channel_id') || null,
          starboard_threshold: parseInt(formData.get('starboard_threshold')) || 3,
          tickets_enabled: formData.get('tickets_enabled') === 'on',
          warnings_enabled: formData.get('warnings_enabled') === 'on',
          analytics_enabled: formData.get('analytics_enabled') === 'on',
          moderation_enabled: formData.get('moderation_enabled') === 'on',
          automod_enabled: formData.get('automod_enabled') === 'on',
          leveling_enabled: formData.get('leveling_enabled') === 'on',
          music_enabled: formData.get('music_enabled') === 'on'
        };
        const result = await API.updateGuildConfig(currentGuild, config);
        if (result.success) {
          alert('Configuration saved!');
          await loadGuildData();
          renderGuildDashboard();
        }
      } else if (e.target.id === 'automod-form') {
        e.preventDefault();
        const formData = new FormData(e.target);

        const exemptRolesRaw = formData.get('exempt_roles') || '';
        const exemptChannelsRaw = formData.get('exempt_channels') || '';

        const rolesValidation = Utils.validateChannelIds(exemptRolesRaw);
        if (!rolesValidation.valid) {
          Utils.showToast(`Invalid role IDs: ${rolesValidation.invalid.join(', ')}`, 'error');
          return;
        }

        const channelsValidation = Utils.validateChannelIds(exemptChannelsRaw);
        if (!channelsValidation.valid) {
          Utils.showToast(`Invalid channel IDs: ${channelsValidation.invalid.join(', ')}`, 'error');
          return;
        }

        const exemptRoles = rolesValidation.ids.join(',');
        const exemptChannels = channelsValidation.ids.join(',');

        const automodConfig = {
          spam_enabled: formData.get('spam_enabled') === 'on',
          spam_threshold: parseInt(formData.get('spam_threshold')) || 5,
          spam_interval: parseInt(formData.get('spam_interval')) || 5,
          spam_similarity_enabled: formData.get('spam_similarity_enabled') === 'on',
          spam_similarity_threshold: parseInt(formData.get('spam_similarity_threshold')) || 80,
          links_enabled: formData.get('links_enabled') === 'on',
          links_whitelist: formData.get('automod_allowed_links') || null,
          caps_enabled: formData.get('caps_enabled') === 'on',
          caps_threshold: parseInt(formData.get('automod_caps_percentage')) || 70,
          caps_min_length: parseInt(formData.get('automod_caps_min_length')) || 10,
          mentions_enabled: formData.get('mentions_enabled') === 'on',
          mentions_threshold: parseInt(formData.get('automod_max_mentions')) || 5,
          profanity_enabled: formData.get('profanity_enabled') === 'on',
          profanity_preset: formData.get('automod_profanity_preset') || 'moderate',
          profanity_list: formData.get('automod_profanity_list') || null,
          profanity_use_word_boundaries: formData.get('profanity_use_word_boundaries') === 'on',
          invites_enabled: formData.get('invites_enabled') === 'on',
          invites_allow_own: formData.get('invites_allow_own') === 'on',
          invites_allowlist: formData.get('automod_allow_invites_list') || null,
          exempt_roles: exemptRoles || null,
          exempt_channels: exemptChannels || null,
          phishing_enabled: formData.get('phishing_enabled') === 'on',
          phishing_action: formData.get('phishing_action') || 'warn',
          account_age_enabled: formData.get('account_age_enabled') === 'on',
          account_age_min_days: parseInt(formData.get('account_age_min_days')) || 7,
          account_age_action: formData.get('account_age_action') || 'kick',
          alt_detection_enabled: formData.get('alt_detection_enabled') === 'on',
          alt_detection_sensitivity: parseInt(formData.get('alt_detection_sensitivity')) || 3,
          alt_detection_action: formData.get('alt_detection_action') || 'warn'
        };

        Utils.showLoadingOverlay('Saving AutoMod settings...');

        try {
          const automodResult = await API.updateAutomod(currentGuild, automodConfig);

          if (automodResult.success) {
            Utils.showToast('AutoMod settings saved successfully!', 'success');
            await loadGuildData();
          }
        } catch (error) {
          console.error('Failed to save automod settings:', error);
        } finally {
          Utils.hideLoadingOverlay();
        }
      } else if (e.target.id === 'add-rule-form') {
        e.preventDefault();
        const formData = new FormData(e.target);
        const result = await API.addRule(currentGuild, formData.get('title'), formData.get('description'));
        if (result.success) {
          e.target.reset();
          await switchTab('rules');
        }
      }
    });

    function initializeEmbedBuilders(config) {
      window.embedBuilders = {};

      const placeholderMap = {
        welcome: ['{user}', '{server}'],
        goodbye: ['{user}', '{server}'],
        ticketOpen: ['{user}', '{subject}'],
        ticketClose: ['{closer}'],
        ticketDm: ['{user}', '{server}', '{subject}', '{closer}']
      };

      const builders = [
        { key: 'welcome', containerId: 'welcome-embed-builder', embedKey: 'welcome_embed', type: 'welcome' },
        { key: 'goodbye', containerId: 'goodbye-embed-builder', embedKey: 'goodbye_embed', type: 'goodbye' },
        { key: 'ticketOpen', containerId: 'ticket-open-embed-builder', embedKey: 'ticket_open_embed', type: 'ticket-open' },
        { key: 'ticketClose', containerId: 'ticket-close-embed-builder', embedKey: 'ticket_close_embed', type: 'ticket-close' },
        { key: 'ticketDm', containerId: 'ticket-dm-embed-builder', embedKey: 'ticket_dm_embed', type: 'ticket-dm' }
      ];

      builders.forEach(({ key, containerId, embedKey, type }) => {
        let initialData = { enabled: false };
        if (config[embedKey]) {
          try {
            initialData = JSON.parse(config[embedKey]);
            initialData.enabled = true;
          } catch (e) {
            console.error(`Failed to parse ${embedKey}:`, e);
          }
        }

        window.embedBuilders[key] = new EmbedBuilder(containerId, {
          initialData,
          placeholders: placeholderMap[key]
        });
      });

      document.querySelectorAll('.toggle-message-type').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const type = e.target.dataset.type;
          const textEditor = document.querySelector(`.message-text-editor[data-type="${type}"]`);
          const embedEditor = document.querySelector(`.message-embed-editor[data-type="${type}"]`);

          if (textEditor.classList.contains('hidden')) {
            textEditor.classList.remove('hidden');
            embedEditor.classList.add('hidden');
            e.target.textContent = 'Switch to Embed Builder';
          } else {
            textEditor.classList.add('hidden');
            embedEditor.classList.remove('hidden');
            e.target.textContent = 'Switch to Text Message';
          }
        });
      });
    }

    function renderChatTab() {
      setTimeout(() => {
        if (!window.chatViewer) {
          window.chatViewer = new ChatViewer();
        }
        window.chatViewer.init();
      }, 100);

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
          <h2 class="text-2xl font-bold text-white mb-6">Live Chat Viewer</h2>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Select Channel</label>
            <select id="chat-channel-selector" class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2">
              <option value="">Loading channels...</option>
            </select>
          </div>
          <div id="chat-messages" class="bg-zinc-900 rounded-lg p-4 h-96 overflow-y-auto scrollbar-thin"></div>
        </div>
      `;
    }

    function renderPermissionsTab() {
      setTimeout(() => {
        if (!window.permissionManager) {
          window.permissionManager = new PermissionManager();
        }
        window.permissionManager.init();
      }, 100);

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
          <h2 class="text-2xl font-bold text-white mb-6">Permission Manager</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold mb-4">Server Roles</h3>
              <div id="permission-role-list" class="bg-zinc-900 rounded-lg max-h-96 overflow-y-auto scrollbar-thin"></div>
            </div>
            <div>
              <div id="permission-role-info"></div>
              <div id="permission-grid" class="grid grid-cols-1 gap-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
              <button id="permission-save-btn" class="hidden mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAppealsTab() {
      setTimeout(() => {
        if (!window.moderationQueue) {
          window.moderationQueue = new ModerationQueue();
        }
        window.moderationQueue.init();
      }, 100);

      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-white mb-2">Moderation Queue</h2>
                <p class="text-zinc-400 text-sm">Review and manage pending appeals and moderation requests</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-zinc-400">Total Appeals:</span>
                <span id="total-appeals-count" class="text-2xl font-bold text-white">0</span>
              </div>
            </div>

            <div class="flex gap-2 mb-6 flex-wrap">
              <button data-appeal-filter="pending" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Pending
                </span>
              </button>
              <button data-appeal-filter="approved" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium transition-colors">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Approved
                </span>
              </button>
              <button data-appeal-filter="denied" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium transition-colors">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Denied
                </span>
              </button>
              <button data-appeal-filter="all" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium transition-colors">
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                  All
                </span>
              </button>
            </div>

            <div id="appeals-list" class="space-y-3">
              <div class="text-center py-12 text-zinc-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-lg font-medium mb-2">No appeals found</p>
                <p class="text-sm">Appeals will appear here when submitted</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAnalyticsTab() {
      setTimeout(() => {
        if (!window.analyticsCharts) {
          window.analyticsCharts = new AnalyticsCharts();
        }
        window.analyticsCharts.init();
      }, 100);

      const analyticsEnabled = !!guildData.config.analytics_enabled;

      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-2xl font-bold text-white mb-2">Server Analytics</h2>
                <p class="text-zinc-400 text-sm">Track server activity, engagement, and growth metrics</p>
              </div>
              <div class="flex gap-2">
                <button onclick="window.analyticsCharts?.init()" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition-colors text-sm flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Refresh
                </button>
                <button data-time-range="24h" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium transition-colors text-sm">Last 24h</button>
                <button data-time-range="7d" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors text-sm">Last 7 Days</button>
                <button data-time-range="30d" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium transition-colors text-sm">Last 30 Days</button>
              </div>
            </div>
            ${analyticsEnabled ? `
              <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3 flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                  <p class="text-xs text-green-200">Analytics tracking is active! Data collection started. Charts will populate as activity occurs.</p>
                </div>
              </div>
            ` : `
              <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="flex-1">
                  <p class="text-xs text-blue-200">Analytics tracking is not yet active. Enable it in the <button onclick="switchTab('config')" class="underline hover:text-blue-100">Configuration</button> tab under "Modules & Features".</p>
                </div>
              </div>
            `}
          </div>

          <div id="analytics-stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${createStatCard('Total Messages', 'N/A', 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z', 'text-blue-400')}
            ${createStatCard('Active Members', 'N/A', 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', 'text-green-400')}
            ${createStatCard('Commands Used', 'N/A', 'M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z', 'text-purple-400')}
            ${createStatCard('Mod Actions', 'N/A', 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z', 'text-red-400')}
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                Message Activity
              </h3>
              <div class="bg-zinc-900 rounded-lg p-4" style="height: 300px; position: relative;">
                <canvas id="messages-chart"></canvas>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                Member Growth
              </h3>
              <div class="bg-zinc-900 rounded-lg p-4" style="height: 300px; position: relative;">
                <canvas id="members-chart"></canvas>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Commands Usage
              </h3>
              <div class="bg-zinc-900 rounded-lg p-4" style="height: 300px; position: relative;">
                <canvas id="commands-chart"></canvas>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Moderation Actions
              </h3>
              <div class="bg-zinc-900 rounded-lg p-4" style="height: 300px; position: relative;">
                <canvas id="moderation-chart"></canvas>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                Top Active Users
              </h3>
              <div id="top-users-list" class="space-y-2 max-h-80 overflow-y-auto">
                <div class="text-center py-8 text-zinc-500">
                  <p class="text-sm">No data available</p>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                </svg>
                Most Active Channels
              </h3>
              <div id="top-channels-list" class="space-y-2 max-h-80 overflow-y-auto">
                <div class="text-center py-8 text-zinc-500">
                  <p class="text-sm">No data available</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderBulkTab() {
      setTimeout(() => {
        if (!window.bulkActions) {
          window.bulkActions = new BulkActions();
        }
        window.bulkActions.init();
      }, 100);

      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="text-2xl font-bold text-white mb-2">Bulk Actions</h2>
                <p class="text-zinc-400 text-sm">Perform moderation actions on multiple users at once</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-zinc-400">Selected:</span>
                <span id="bulk-selected-count" class="text-2xl font-bold text-white">0</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
              <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Select Action Type
                </h3>
                <div class="grid grid-cols-2 gap-3">
                  <button data-bulk-action="ban" class="p-4 rounded-lg bg-zinc-700 hover:bg-red-600/20 border-2 border-zinc-600 hover:border-red-500 text-zinc-300 hover:text-white transition-all group">
                    <div class="flex items-center gap-3">
                      <svg class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                      </svg>
                      <div class="text-left">
                        <div class="font-semibold">Ban Users</div>
                        <div class="text-xs text-zinc-400 group-hover:text-zinc-300">Permanently ban members</div>
                      </div>
                    </div>
                  </button>

                  <button data-bulk-action="kick" class="p-4 rounded-lg bg-zinc-700 hover:bg-orange-600/20 border-2 border-zinc-600 hover:border-orange-500 text-zinc-300 hover:text-white transition-all group">
                    <div class="flex items-center gap-3">
                      <svg class="w-6 h-6 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                      </svg>
                      <div class="text-left">
                        <div class="font-semibold">Kick Users</div>
                        <div class="text-xs text-zinc-400 group-hover:text-zinc-300">Remove from server</div>
                      </div>
                    </div>
                  </button>

                  <button data-bulk-action="role_add" class="p-4 rounded-lg bg-zinc-700 hover:bg-green-600/20 border-2 border-zinc-600 hover:border-green-500 text-zinc-300 hover:text-white transition-all group">
                    <div class="flex items-center gap-3">
                      <svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                      <div class="text-left">
                        <div class="font-semibold">Add Role</div>
                        <div class="text-xs text-zinc-400 group-hover:text-zinc-300">Assign role to users</div>
                      </div>
                    </div>
                  </button>

                  <button data-bulk-action="role_remove" class="p-4 rounded-lg bg-zinc-700 hover:bg-yellow-600/20 border-2 border-zinc-600 hover:border-yellow-500 text-zinc-300 hover:text-white transition-all group">
                    <div class="flex items-center gap-3">
                      <svg class="w-6 h-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                      </svg>
                      <div class="text-left">
                        <div class="font-semibold">Remove Role</div>
                        <div class="text-xs text-zinc-400 group-hover:text-zinc-300">Remove role from users</div>
                      </div>
                    </div>
                  </button>
                </div>

                <div id="bulk-role-selector" class="hidden mt-4">
                  <label class="block text-sm font-medium text-zinc-300 mb-2">Select Role</label>
                  <select id="bulk-role-select" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-indigo-500">
                    <option value="">Choose a role...</option>
                  </select>
                </div>
              </div>

              <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                  Add Target Users
                </h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-zinc-300 mb-2">User IDs</label>
                    <textarea id="bulk-user-input" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-4 py-3 text-white h-32 focus:outline-none focus:border-indigo-500 font-mono text-sm" placeholder="Enter user IDs (comma or newline separated)&#10;&#10;Example:&#10;123456789012345678&#10;987654321098765432&#10;or: 123456789012345678, 987654321098765432"></textarea>
                    <p class="text-xs text-zinc-400 mt-2">Tip: You can paste multiple user IDs separated by commas or new lines</p>
                  </div>
                  <button onclick="window.bulkActions.parseUserInput()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Add Users to List
                  </button>
                </div>
              </div>

              <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Action Details
                </h3>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-zinc-300 mb-2">Reason (Optional)</label>
                  <input type="text" id="bulk-reason" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-indigo-500" placeholder="Enter reason for this action...">
                  <p class="text-xs text-zinc-400 mt-2">This reason will be logged and visible in audit logs</p>
                </div>

                <div class="bg-yellow-900/20 border border-yellow-500/50 rounded-lg p-4 mb-4">
                  <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-yellow-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div class="text-sm text-yellow-200">
                      <strong class="font-semibold">Warning:</strong> Bulk actions cannot be undone. Please review your selection carefully before executing.
                    </div>
                  </div>
                </div>

                <button id="bulk-execute-btn" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  Execute Bulk Action
                </button>
              </div>
            </div>

            <div class="space-y-6">
              <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                  Selected Users
                </h3>
                <div id="bulk-selected-users" class="space-y-2 max-h-96 overflow-y-auto">
                  <div class="text-center py-8 text-zinc-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <p class="text-sm">No users selected</p>
                  </div>
                </div>
              </div>

              <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Action History
                </h3>
                <div id="bulk-history-list" class="space-y-2 max-h-96 overflow-y-auto">
                  <div class="text-center py-8 text-zinc-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    <p class="text-sm">No history available</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderBackupsTab() {
      setTimeout(() => {
        if (!window.backupManager) {
          window.backupManager = new BackupManager();
        }
        window.backupManager.init();
      }, 100);

      return `
        <div class="space-y-6">
          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-white mb-2">üíæ Backup Management</h2>
                <p class="text-zinc-400 text-sm">Create, restore, and manage server configuration backups to protect your settings.</p>
              </div>
              <button id="backup-create-btn" class="btn-primary px-6 py-3 flex items-center gap-2 whitespace-nowrap">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Create New Backup
              </button>
            </div>

            <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-6">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="text-sm text-blue-200">
                  <strong class="font-semibold">Quick Tip:</strong> Regular backups help you quickly recover your server configuration if something goes wrong. We recommend creating a backup before making major changes.
                </div>
              </div>
            </div>

            <div id="backups-list" class="space-y-4"></div>
          </div>

          <div class="bg-zinc-800 border border-zinc-700 rounded-lg p-6">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-white mb-2">‚è∞ Automatic Database Backups</h2>
              <p class="text-zinc-400 text-sm">System-generated backups of the entire database (all servers and bot data)</p>
            </div>

            <div class="mb-6 p-4 bg-zinc-900/50 rounded-lg">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="font-semibold text-white mb-1">‚è∞ Auto-Backup</h3>
                  <p class="text-sm text-zinc-400">Automatically create database backups on a schedule</p>
                </div>
                <div class="flex items-center gap-4">
                  <div id="autobackup-status" class="text-sm">
                    <span class="text-zinc-400">Loading...</span>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autobackup-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-zinc-700 peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                  </label>
                </div>
              </div>
              <div id="autobackup-interval-container" class="flex items-center gap-3" style="display: none;">
                <label class="text-sm text-zinc-300">Interval:</label>
                <select id="autobackup-interval" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-1 text-sm">
                  <option value="6">Every 6 hours</option>
                  <option value="12">Every 12 hours</option>
                  <option value="24" selected>Every 24 hours</option>
                  <option value="48">Every 48 hours</option>
                  <option value="168">Every 7 days</option>
                </select>
              </div>
            </div>

            <div id="system-backups-list" class="space-y-3"></div>
          </div>
        </div>
      `;
    }

    function renderDashboardAuditTab() {
      setTimeout(() => {
        loadDashboardAudit();
        initAuditQuickFilters();
      }, 100);

      return `
        <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
          <div class="p-6 border-b border-zinc-700">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-2xl font-bold text-white">Dashboard Security Logs</h2>
                <p class="text-zinc-400 text-sm mt-1">Track all dashboard access and actions for security auditing</p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="exportAuditLogs('csv')"
                  class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition flex items-center gap-2"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export CSV
                </button>
                <button
                  onclick="exportAuditLogs('json')"
                  class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition flex items-center gap-2"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export JSON
                </button>
              </div>
            </div>

            <div class="mb-4">
              <div class="flex gap-2 mb-4">
                <button onclick="setQuickFilter('1h')" class="quick-filter-btn px-3 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition">Last Hour</button>
                <button onclick="setQuickFilter('24h')" class="quick-filter-btn px-3 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition">Last 24h</button>
                <button onclick="setQuickFilter('7d')" class="quick-filter-btn px-3 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition">Last 7 Days</button>
                <button onclick="setQuickFilter('30d')" class="quick-filter-btn px-3 py-1 text-xs bg-zinc-700 hover:bg-zinc-600 rounded transition">Last 30 Days</button>
                <button onclick="setQuickFilter('all')" class="quick-filter-btn active px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 rounded transition">All Time</button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium mb-2 text-zinc-300">Search</label>
                <input
                  type="text"
                  id="audit-filter-search"
                  placeholder="Username, User ID, or IP..."
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-zinc-300">Action Type</label>
                <select
                  id="audit-filter-action"
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                >
                  <option value="">All Actions</option>
                  <option value="LOGIN">Login</option>
                  <option value="LOGOUT">Logout</option>
                  <option value="ACCESS_GUILD">Access Guild</option>
                  <option value="VIEW_CONFIG">View Config</option>
                  <option value="UPDATE_CONFIG">Update Config</option>
                  <option value="VIEW_WARNINGS">View Warnings</option>
                  <option value="DELETE_WARNING">Delete Warning</option>
                  <option value="UPDATE_AUTOMOD">Update AutoMod</option>
                  <option value="EXECUTE_BULK_ACTION">Bulk Action</option>
                  <option value="CREATE_BACKUP">Create Backup</option>
                  <option value="DELETE_BACKUP">Delete Backup</option>
                  <option value="VIEW_ANALYTICS">View Analytics</option>
                  <option value="VIEW_APPEALS">View Appeals</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-zinc-300">Status</label>
                <select
                  id="audit-filter-success"
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                >
                  <option value="">All Status</option>
                  <option value="true">Success Only</option>
                  <option value="false">Failed Only</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-zinc-300">Start Date</label>
                <input
                  type="datetime-local"
                  id="audit-filter-start"
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 text-zinc-300">End Date</label>
                <input
                  type="datetime-local"
                  id="audit-filter-end"
                  class="w-full bg-zinc-700 border border-zinc-600 rounded px-4 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition"
                />
              </div>
            </div>

            <div class="flex gap-2">
              <button
                onclick="loadDashboardAudit()"
                class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded text-sm transition flex items-center gap-2"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Apply Filters
              </button>
              <button
                onclick="clearAuditFilters()"
                class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded text-sm transition"
              >
                Clear
              </button>
            </div>
          </div>

          <div class="p-6 bg-zinc-900/50 border-b border-zinc-700">
            <h3 class="font-semibold mb-4 text-white">Summary</h3>
            <div id="audit-summary" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
              <div class="loading-skeleton h-20 rounded"></div>
              <div class="loading-skeleton h-20 rounded"></div>
              <div class="loading-skeleton h-20 rounded"></div>
              <div class="loading-skeleton h-20 rounded"></div>
              <div class="loading-skeleton h-20 rounded"></div>
            </div>
            <div id="audit-stats" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <div class="loading-skeleton h-16 rounded"></div>
              <div class="loading-skeleton h-16 rounded"></div>
              <div class="loading-skeleton h-16 rounded"></div>
              <div class="loading-skeleton h-16 rounded"></div>
            </div>
          </div>

          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <div id="audit-pagination-info" class="text-sm text-zinc-400">
                Loading...
              </div>
              <div id="audit-pagination-controls" class="flex gap-2">
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-zinc-900/50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Guild</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">IP Address</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Details</th>
                  </tr>
                </thead>
                <tbody id="audit-logs-tbody" class="divide-y divide-zinc-700">
                  <tr><td colspan="7" class="px-6 py-8 text-center text-zinc-400">
                    <div class="loading-skeleton h-8 w-48 mx-auto rounded"></div>
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    let currentAuditPage = 0;
    const auditPageSize = 50;

    async function loadDashboardAudit(page = 0) {
      try {
        currentAuditPage = page;
        const search = document.getElementById('audit-filter-search')?.value || '';
        const actionType = document.getElementById('audit-filter-action')?.value || '';
        const success = document.getElementById('audit-filter-success')?.value || '';
        const startDate = document.getElementById('audit-filter-start')?.value || '';
        const endDate = document.getElementById('audit-filter-end')?.value || '';

        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (actionType) params.append('actionType', actionType);
        if (success) params.append('success', success);
        if (startDate) params.append('startDate', Math.floor(new Date(startDate).getTime() / 1000).toString());
        if (endDate) params.append('endDate', Math.floor(new Date(endDate).getTime() / 1000).toString());
        params.append('limit', auditPageSize.toString());
        params.append('offset', (page * auditPageSize).toString());

        const summaryParams = new URLSearchParams();
        if (startDate) summaryParams.append('startDate', Math.floor(new Date(startDate).getTime() / 1000).toString());
        if (endDate) summaryParams.append('endDate', Math.floor(new Date(endDate).getTime() / 1000).toString());

        const [logsRes, statsRes, summaryRes] = await Promise.all([
          fetch(`/api/dashboard-audit?${params.toString()}`, { credentials: 'include' }),
          fetch(`/api/dashboard-audit/stats?${summaryParams.toString()}`, { credentials: 'include' }),
          fetch(`/api/dashboard-audit/summary?${summaryParams.toString()}`, { credentials: 'include' })
        ]);

        const logsResult = await logsRes.json();
        const statsResult = await statsRes.json();
        const summaryResult = await summaryRes.json();

        if (summaryResult.success && summaryResult.data) {
          const summary = summaryResult.data;
          const successRate = summary.total_actions > 0
            ? ((summary.successful_actions / summary.total_actions) * 100).toFixed(1)
            : 0;

          const summaryHtml = `
            <div class="bg-zinc-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-white mb-1">${summary.total_actions || 0}</div>
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Total Actions</div>
            </div>
            <div class="bg-zinc-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-green-400 mb-1">${summary.successful_actions || 0}</div>
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Successful</div>
            </div>
            <div class="bg-zinc-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-red-400 mb-1">${summary.failed_actions || 0}</div>
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Failed</div>
            </div>
            <div class="bg-zinc-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-blue-400 mb-1">${summary.unique_users || 0}</div>
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Unique Users</div>
            </div>
            <div class="bg-zinc-800 rounded-lg p-4 text-center">
              <div class="text-3xl font-bold text-indigo-400 mb-1">${successRate}%</div>
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Success Rate</div>
            </div>
          `;
          document.getElementById('audit-summary').innerHTML = summaryHtml;
        }

        if (statsResult.success) {
          const statsHtml = statsResult.data.slice(0, 6).map(stat => {
            const actionColor = getActionColor(stat.action_type);
            return `
              <div class="bg-zinc-800 rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs ${actionColor.split(' ')[1]} font-medium">${stat.action_type.replace(/_/g, ' ')}</span>
                  <span class="text-lg font-bold text-white">${stat.count}</span>
                </div>
                <div class="flex gap-2 text-xs">
                  <span class="text-green-400">‚úì ${stat.successful}</span>
                  <span class="text-red-400">‚úó ${stat.failed}</span>
                </div>
              </div>
            `;
          }).join('');
          document.getElementById('audit-stats').innerHTML = statsHtml || '<div class="col-span-6 text-center text-zinc-500">No data</div>';
        }

        if (logsResult.success) {
          const tbody = document.getElementById('audit-logs-tbody');

          if (logsResult.data.length === 0) {
            tbody.innerHTML = `
              <tr><td colspan="7" class="px-6 py-12 text-center">
                <div class="text-zinc-500 mb-2">
                  <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <div class="text-zinc-400 font-medium">No audit logs found</div>
                <div class="text-zinc-500 text-sm mt-1">Try adjusting your filters</div>
              </td></tr>
            `;
            document.getElementById('audit-pagination-info').textContent = 'No results';
            document.getElementById('audit-pagination-controls').innerHTML = '';
            return;
          }

          const logsHtml = logsResult.data.map((log, index) => `
            <tr class="hover:bg-zinc-700/50 transition-colors audit-log-row" data-log-id="${log.id}">
              <td class="px-6 py-4 text-sm text-zinc-300">
                <div title="${new Date(log.timestamp * 1000).toLocaleString()}">${formatRelativeTime(log.timestamp)}</div>
                <div class="text-xs text-zinc-500">${new Date(log.timestamp * 1000).toLocaleTimeString()}</div>
              </td>
              <td class="px-6 py-4 text-sm">
                <div class="font-medium text-white">${log.username}${log.discriminator !== '0' ? '#' + log.discriminator : ''}</div>
                <div class="text-xs text-zinc-500 font-mono">${log.user_id}</div>
              </td>
              <td class="px-6 py-4 text-sm">
                <span class="px-2 py-1 text-xs rounded font-medium ${getActionColor(log.action_type)}">
                  ${getActionIcon(log.action_type)} ${log.action_type.replace(/_/g, ' ')}
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-zinc-400">
                ${log.guild_name ? `<div class="font-medium">${log.guild_name}</div><div class="text-xs text-zinc-500">${log.guild_id}</div>` : '<span class="text-zinc-600">N/A</span>'}
              </td>
              <td class="px-6 py-4 text-sm text-zinc-400 font-mono text-xs">
                ${log.ip_address || '<span class="text-zinc-600">N/A</span>'}
              </td>
              <td class="px-6 py-4 text-sm">
                ${log.success
                  ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-900/30 text-green-400">‚úì Success</span>'
                  : '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-900/30 text-red-400">‚úó Failed</span>'}
              </td>
              <td class="px-6 py-4 text-sm">
                <button onclick="toggleAuditDetails(${index}, ${log.id})" class="text-indigo-400 hover:text-indigo-300 text-xs font-medium transition">
                  View
                </button>
              </td>
            </tr>
            <tr id="audit-details-${index}" class="hidden audit-details-row bg-zinc-900/50">
              <td colspan="7" class="px-6 py-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-zinc-400 font-medium">Resource:</span>
                    <span class="text-white ml-2">${log.resource || 'N/A'}</span>
                  </div>
                  <div>
                    <span class="text-zinc-400 font-medium">Method:</span>
                    <span class="text-white ml-2">${log.method || 'N/A'}</span>
                  </div>
                  <div>
                    <span class="text-zinc-400 font-medium">User Agent:</span>
                    <span class="text-zinc-300 ml-2 text-xs font-mono">${log.user_agent || 'N/A'}</span>
                  </div>
                  ${log.error_message ? `
                    <div class="col-span-2">
                      <span class="text-red-400 font-medium">Error:</span>
                      <span class="text-red-300 ml-2">${log.error_message}</span>
                    </div>
                  ` : ''}
                  ${log.details ? `
                    <div class="col-span-2">
                      <span class="text-zinc-400 font-medium">Details:</span>
                      <pre class="text-xs text-zinc-300 mt-2 bg-zinc-800 p-3 rounded overflow-auto max-h-40">${JSON.stringify(JSON.parse(log.details), null, 2)}</pre>
                    </div>
                  ` : ''}
                </div>
              </td>
            </tr>
          `).join('');

          tbody.innerHTML = logsHtml;

          const { total, offset, limit } = logsResult.pagination;
          const start = offset + 1;
          const end = Math.min(offset + logsResult.data.length, total);

          document.getElementById('audit-pagination-info').textContent =
            `Showing ${start}-${end} of ${total} results`;

          const totalPages = Math.ceil(total / limit);
          const currentPage = Math.floor(offset / limit);

          let paginationHtml = '';
          if (currentPage > 0) {
            paginationHtml += `<button onclick="loadDashboardAudit(${currentPage - 1})" class="px-3 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-sm transition">‚Üê Previous</button>`;
          }

          const pageStart = Math.max(0, currentPage - 2);
          const pageEnd = Math.min(totalPages, currentPage + 3);

          for (let i = pageStart; i < pageEnd; i++) {
            const isActive = i === currentPage;
            paginationHtml += `
              <button
                onclick="loadDashboardAudit(${i})"
                class="px-3 py-1 ${isActive ? 'bg-indigo-600' : 'bg-zinc-700 hover:bg-zinc-600'} rounded text-sm transition"
              >
                ${i + 1}
              </button>
            `;
          }

          if (currentPage < totalPages - 1) {
            paginationHtml += `<button onclick="loadDashboardAudit(${currentPage + 1})" class="px-3 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-sm transition">Next ‚Üí</button>`;
          }

          document.getElementById('audit-pagination-controls').innerHTML = paginationHtml;
        }
      } catch (error) {
        console.error('Failed to load dashboard audit:', error);
        document.getElementById('audit-logs-tbody').innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-400">Failed to load audit logs</td></tr>';
      }
    }

    function getActionColor(actionType) {
      const colors = {
        LOGIN: 'bg-green-900/30 text-green-400',
        LOGOUT: 'bg-gray-900/30 text-gray-400',
        ACCESS_GUILD: 'bg-blue-900/30 text-blue-400',
        UPDATE_CONFIG: 'bg-yellow-900/30 text-yellow-400',
        DELETE_WARNING: 'bg-red-900/30 text-red-400',
        EXECUTE_BULK_ACTION: 'bg-purple-900/30 text-purple-400',
        CREATE_BACKUP: 'bg-cyan-900/30 text-cyan-400',
        DELETE_BACKUP: 'bg-orange-900/30 text-orange-400',
        UPDATE_AUTOMOD: 'bg-amber-900/30 text-amber-400',
        VIEW_CONFIG: 'bg-sky-900/30 text-sky-400',
        VIEW_ANALYTICS: 'bg-indigo-900/30 text-indigo-400',
        VIEW_WARNINGS: 'bg-slate-900/30 text-slate-400'
      };

      return colors[actionType] || 'bg-zinc-700 text-zinc-300';
    }

    function getActionIcon(actionType) {
      const icons = {
        LOGIN: 'üîì',
        LOGOUT: 'üîí',
        ACCESS_GUILD: 'üè†',
        UPDATE_CONFIG: '‚öôÔ∏è',
        DELETE_WARNING: 'üóëÔ∏è',
        EXECUTE_BULK_ACTION: '‚ö°',
        CREATE_BACKUP: 'üíæ',
        DELETE_BACKUP: 'üóëÔ∏è',
        UPDATE_AUTOMOD: 'üõ°Ô∏è',
        VIEW_CONFIG: 'üëÅÔ∏è',
        VIEW_ANALYTICS: 'üìä',
        VIEW_WARNINGS: '‚ö†Ô∏è'
      };
      return icons[actionType] || 'üìã';
    }

    function formatRelativeTime(timestamp) {
      const now = Math.floor(Date.now() / 1000);
      const diff = now - timestamp;

      if (diff < 60) return 'Just now';
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
      return new Date(timestamp * 1000).toLocaleDateString();
    }

    function toggleAuditDetails(index, logId) {
      const detailsRow = document.getElementById(`audit-details-${index}`);
      if (detailsRow) {
        detailsRow.classList.toggle('hidden');
      }
    }

    function clearAuditFilters() {
      document.getElementById('audit-filter-search').value = '';
      document.getElementById('audit-filter-action').value = '';
      document.getElementById('audit-filter-success').value = '';
      document.getElementById('audit-filter-start').value = '';
      document.getElementById('audit-filter-end').value = '';

      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-600');
        btn.classList.add('bg-zinc-700');
      });
      document.querySelector('.quick-filter-btn[onclick*="all"]')?.classList.add('active', 'bg-indigo-600');
      document.querySelector('.quick-filter-btn[onclick*="all"]')?.classList.remove('bg-zinc-700');

      loadDashboardAudit(0);
    }

    function setQuickFilter(range) {
      const now = new Date();
      let startDate;

      switch(range) {
        case '1h':
          startDate = new Date(now.getTime() - 3600000);
          break;
        case '24h':
          startDate = new Date(now.getTime() - 86400000);
          break;
        case '7d':
          startDate = new Date(now.getTime() - 604800000);
          break;
        case '30d':
          startDate = new Date(now.getTime() - 2592000000);
          break;
        case 'all':
          document.getElementById('audit-filter-start').value = '';
          document.getElementById('audit-filter-end').value = '';
          break;
      }

      if (range !== 'all') {
        const startStr = startDate.toISOString().slice(0, 16);
        const endStr = now.toISOString().slice(0, 16);
        document.getElementById('audit-filter-start').value = startStr;
        document.getElementById('audit-filter-end').value = endStr;
      }

      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-600');
        btn.classList.add('bg-zinc-700');
      });

      event.target.classList.add('active', 'bg-indigo-600');
      event.target.classList.remove('bg-zinc-700');

      loadDashboardAudit(0);
    }

    function initAuditQuickFilters() {
      document.getElementById('audit-filter-search')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loadDashboardAudit(0);
        }
      });
    }

    function exportAuditLogs(format) {
      const search = document.getElementById('audit-filter-search')?.value || '';
      const actionType = document.getElementById('audit-filter-action')?.value || '';
      const success = document.getElementById('audit-filter-success')?.value || '';
      const startDate = document.getElementById('audit-filter-start')?.value || '';
      const endDate = document.getElementById('audit-filter-end')?.value || '';

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (actionType) params.append('actionType', actionType);
      if (success) params.append('success', success);
      if (startDate) params.append('startDate', Math.floor(new Date(startDate).getTime() / 1000).toString());
      if (endDate) params.append('endDate', Math.floor(new Date(endDate).getTime() / 1000).toString());
      params.append('format', format);

      window.open(`/api/dashboard-audit/export?${params.toString()}`, '_blank');
    }

    function renderAccountSettingsPage() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
              <div class="p-6 border-b border-zinc-700">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                  <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Profile & Preferences
                </h2>
                <p class="text-zinc-400 text-sm mt-1">Manage your account settings and preferences</p>
              </div>

              <div class="p-6 space-y-6">
                <div>
                  <label class="block text-sm font-medium text-zinc-300 mb-2">Session Timeout</label>
                  <select id="setting-session-timeout" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-4 py-2 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition">
                    <option value="3600">1 Hour</option>
                    <option value="28800">8 Hours</option>
                    <option value="86400">24 Hours</option>
                    <option value="604800">7 Days</option>
                    <option value="2592000">30 Days</option>
                  </select>
                  <p class="text-xs text-zinc-500 mt-2">Automatically log out after this period of inactivity</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-zinc-300 mb-2">Theme</label>
                  <select id="setting-theme" class="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-4 py-2 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="auto">Auto (System)</option>
                  </select>
                </div>

                <div class="flex gap-3 pt-4">
                  <button onclick="saveUserSettings()" class="btn-primary flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Changes
                  </button>
                  <button onclick="loadUserSettings()" class="btn-secondary">Reset</button>
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
              <div class="p-6 border-b border-zinc-700">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                  <svg class="w-6 h-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                  </svg>
                  Security
                </h2>
                <p class="text-zinc-400 text-sm mt-1">Manage your account security settings</p>
              </div>

              <div class="p-6 space-y-6">
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                  <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-200">
                      <strong class="font-semibold">Two-Factor Authentication</strong> is coming soon! This will add an extra layer of security to your account.
                    </div>
                  </div>
                </div>

                <div>
                  <button onclick="terminateAllSessions()" class="w-full bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 text-red-400 px-4 py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Terminate All Sessions
                  </button>
                  <p class="text-xs text-zinc-500 mt-2">Log out from all devices except this one</p>
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-6">
            <div class="bg-zinc-800 border border-zinc-700 rounded-lg">
              <div class="p-6 border-b border-zinc-700">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                  <svg class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                  </svg>
                  Active Sessions
                </h2>
                <p class="text-zinc-400 text-sm mt-1">Manage your active login sessions</p>
              </div>

              <div id="active-sessions-list" class="p-6 space-y-3">
                <div class="text-center py-8 text-zinc-500">
                  <div class="loading-skeleton h-20 rounded mb-3"></div>
                  <div class="loading-skeleton h-20 rounded"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      `;
    }

    async function loadUserSettings() {
      try {
        const response = await fetch('/api/user/settings', { credentials: 'include' });
        const result = await response.json();

        if (result.success && result.data) {
          const settings = result.data;
          document.getElementById('setting-session-timeout').value = settings.session_timeout || 86400;
          document.getElementById('setting-theme').value = settings.theme || 'dark';
        }
      } catch (error) {
        console.error('Failed to load user settings:', error);
      }
    }

    async function saveUserSettings() {
      try {
        const settings = {
          session_timeout: parseInt(document.getElementById('setting-session-timeout').value),
          theme: document.getElementById('setting-theme').value
        };

        const response = await fetch('/api/user/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(settings)
        });

        const result = await response.json();

        if (result.success) {
          showNotification('Settings saved successfully!', 'success');
        } else {
          showNotification('Failed to save settings', 'error');
        }
      } catch (error) {
        console.error('Failed to save user settings:', error);
        showNotification('Failed to save settings', 'error');
      }
    }

    async function loadUserSessions() {
      try {
        const response = await fetch('/api/user/sessions', { credentials: 'include' });
        const result = await response.json();

        const container = document.getElementById('active-sessions-list');

        if (result.success && result.data && result.data.length > 0) {
          const sessionsHtml = result.data.map(session => {
            const createdDate = new Date(session.created_at * 1000);
            const lastActivity = new Date(session.last_activity * 1000);

            return `
              <div class="bg-zinc-900/50 border border-zinc-700 rounded-lg p-4">
                <div class="flex items-start justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-green-400">Active</span>
                  </div>
                  <button onclick="terminateSession('${session.session_id}')" class="text-red-400 hover:text-red-300 text-xs font-medium">
                    Terminate
                  </button>
                </div>
                <div class="space-y-1 text-xs text-zinc-400">
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="font-mono">${session.ip_address || 'Unknown'}</span>
                  </div>
                  <div class="truncate" title="${session.user_agent}">
                    ${session.user_agent || 'Unknown device'}
                  </div>
                  <div class="flex items-center gap-2 text-zinc-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Created ${formatRelativeTime(session.created_at)}</span>
                  </div>
                  <div class="flex items-center gap-2 text-zinc-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>Last active ${formatRelativeTime(session.last_activity)}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = sessionsHtml;
        } else {
          container.innerHTML = `
            <div class="text-center py-8 text-zinc-500">
              <svg class="w-12 h-12 mx-auto mb-3 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              <p class="text-sm">No active sessions</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load sessions:', error);
      }
    }

    async function terminateSession(sessionId) {
      if (!confirm('Are you sure you want to terminate this session?')) return;

      try {
        const response = await fetch(`/api/user/sessions/${sessionId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
          showNotification('Session terminated successfully', 'success');
          loadUserSessions();
        } else {
          showNotification('Failed to terminate session', 'error');
        }
      } catch (error) {
        console.error('Failed to terminate session:', error);
        showNotification('Failed to terminate session', 'error');
      }
    }

    async function terminateAllSessions() {
      if (!confirm('Are you sure you want to terminate ALL sessions? You will remain logged in on this device.')) return;

      try {
        const response = await fetch('/api/user/sessions', {
          method: 'DELETE',
          credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
          showNotification('All sessions terminated successfully', 'success');
          loadUserSessions();
        } else {
          showNotification('Failed to terminate sessions', 'error');
        }
      } catch (error) {
        console.error('Failed to terminate all sessions:', error);
        showNotification('Failed to terminate sessions', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const notificationContainer = document.getElementById('notification-container') || createNotificationContainer();

      const notification = document.createElement('div');
      notification.className = `notification ${type} animate-slide-in`;

      const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600',
        warning: 'bg-yellow-600'
      };

      const icons = {
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
      };

      notification.innerHTML = `
        <div class="${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]">
          ${icons[type]}
          <span class="font-medium">${message}</span>
        </div>
      `;

      notificationContainer.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('animate-slide-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function createNotificationContainer() {
      const container = document.createElement('div');
      container.id = 'notification-container';
      container.className = 'fixed top-4 right-4 z-50 space-y-2';
      document.body.appendChild(container);
      return container;
    }

    function filterWarnings(searchTerm) {
      const rows = document.querySelectorAll('.warning-row');
      let visibleCount = 0;

      rows.forEach(row => {
        const userId = row.getAttribute('data-user-id') || '';
        const moderatorId = row.getAttribute('data-moderator-id') || '';
        const reason = row.getAttribute('data-reason') || '';

        const matches = userId.toLowerCase().includes(searchTerm) ||
                       moderatorId.toLowerCase().includes(searchTerm) ||
                       reason.includes(searchTerm);

        if (matches || searchTerm === '') {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      const tbody = document.getElementById('warnings-tbody');
      if (tbody && visibleCount === 0 && searchTerm !== '') {
        const existingNoResults = tbody.querySelector('.no-results-row');
        if (!existingNoResults) {
          const noResultsRow = document.createElement('tr');
          noResultsRow.className = 'no-results-row';
          noResultsRow.innerHTML = '<td colspan="6" class="px-6 py-8 text-center text-zinc-400">No warnings match your search</td>';
          tbody.appendChild(noResultsRow);
        }
      } else {
        const noResultsRow = tbody?.querySelector('.no-results-row');
        if (noResultsRow) {
          noResultsRow.remove();
        }
      }
    }

    function filterLogs(searchTerm) {
      const rows = document.querySelectorAll('.log-row');
      let visibleCount = 0;

      rows.forEach(row => {
        const action = row.getAttribute('data-action') || '';
        const moderatorId = row.getAttribute('data-moderator-id') || '';
        const targetId = row.getAttribute('data-target-id') || '';
        const reason = row.getAttribute('data-reason') || '';

        const matches = action.includes(searchTerm) ||
                       moderatorId.toLowerCase().includes(searchTerm) ||
                       targetId.toLowerCase().includes(searchTerm) ||
                       reason.includes(searchTerm);

        if (matches || searchTerm === '') {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      const tbody = document.getElementById('logs-tbody');
      if (tbody && visibleCount === 0 && searchTerm !== '') {
        const existingNoResults = tbody.querySelector('.no-results-row');
        if (!existingNoResults) {
          const noResultsRow = document.createElement('tr');
          noResultsRow.className = 'no-results-row';
          noResultsRow.innerHTML = '<td colspan="5" class="px-6 py-8 text-center text-zinc-400">No logs match your search</td>';
          tbody.appendChild(noResultsRow);
        }
      } else {
        const noResultsRow = tbody?.querySelector('.no-results-row');
        if (noResultsRow) {
          noResultsRow.remove();
        }
      }
    }

    const originalRenderGuildDashboard = renderGuildDashboard;
    renderGuildDashboard = function() {
      originalRenderGuildDashboard();
      if (guildData?.config && (currentTab === 'config' || currentTab === 'overview')) {
        setTimeout(() => {
          initializeEmbedBuilders(guildData.config);
        }, 0);
      }
    };

    showMainDashboard();
  </script>
</body>
</html>
